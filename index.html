<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Sollar | Inteligência Energética</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');
        :root { --bg-deep: #0a1120; --accent-blue: #3b82f6; --accent-yellow: #facc15; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 10% 80%, rgba(250, 204, 21, 0.05) 0%, transparent 30%);
            background-attachment: fixed;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .card-glow { position: relative; }
        .card-glow::before {
            content: ""; position: absolute; inset: -1px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), transparent, rgba(250, 204, 21, 0.5));
            border-radius: 2.5rem; z-index: -1; opacity: 0.4;
        }
        
        /* INPUTS COM ÍCONES */
        .input-wrapper { position: relative; }
        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
            transition: color 0.3s ease;
        }
        .input-dark {
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            color: #fff !important;
            padding-left: 50px !important;
            transition: all 0.3s ease;
        }
        .input-dark:focus {
            border-color: var(--accent-blue) !important;
            background: rgba(0, 0, 0, 0.6) !important;
            outline: none;
        }
        .input-dark:focus + .input-icon, .input-wrapper:focus-within .input-icon {
            color: var(--accent-blue);
        }

        .btn-yellow {
            background: linear-gradient(135deg, #facc15 0%, #eab308 100%);
            color: #000; font-weight: 800;
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
            transition: all 0.3s ease;
        }
        .btn-yellow:hover { transform: scale(1.02); box-shadow: 0 0 35px rgba(250, 204, 21, 0.6); }
        .btn-yellow:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        /* CORREÇÃO DO AUTOCOMPLETE DO GOOGLE */
        .pac-container { 
            background-color: #1e293b !important; 
            border-radius: 1rem !important; 
            border: 1px solid rgba(255,255,255,0.1) !important;
            font-family: inherit !important; 
            z-index: 9999 !important;
            margin-top: 5px !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important;
        }
        .pac-item { color: #94a3b8 !important; padding: 12px 16px !important; border-top: 1px solid rgba(255,255,255,0.05) !important; cursor: pointer !important; }
        .pac-item:hover { background-color: rgba(255,255,255,0.05) !important; color: white !important; }
        .pac-item-query { color: white !important; font-weight: bold; }
        .pac-logo::after { display: none; }
    </style>
</head>
<body class="overflow-x-hidden">

    <nav class="container mx-auto p-8 flex justify-between items-center relative z-10">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-solar-panel text-white text-2xl"></i>
            </div>
            <span class="text-2xl font-black tracking-tighter uppercase">Pro-<span class="text-blue-500">Sollar</span></span>
        </div>
        <a href="login.html" class="bg-blue-600/20 border border-blue-500/30 px-6 py-2 rounded-full text-sm font-bold hover:bg-blue-600 transition text-white">
            <i class="fas fa-user-circle mr-2"></i> Área do Cliente
        </a>
    </nav>

    <main class="container mx-auto px-6 py-12 grid lg:grid-cols-2 gap-16 items-center">
        <div class="space-y-8">
            <h1 class="text-6xl lg:text-7xl font-extrabold leading-[1.1]">
                Economia que vem do <span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">Céu.</span>
            </h1>
            <p class="text-slate-400 text-xl max-w-lg">Análise inteligente via satélite para entregar sua independência energética em segundos.</p>
        </div>

        <div class="card-glow">
            <div class="glass-card p-10 space-y-6 min-h-[500px] flex flex-col justify-center">
                
                <div id="form-container">
                    <h2 class="text-2xl font-bold mb-6">Simule Seu Potencial</h2>
                    <form id="simuladorForm" class="space-y-4">
                        
                        <div class="input-wrapper">
                            <input type="text" id="endereco" placeholder="Endereço da Instalação" class="input-dark w-full px-4 py-4 rounded-2xl text-sm">
                            <i class="fas fa-map-marker-alt input-icon"></i>
                        </div>

                        <div class="input-wrapper">
                            <input type="tel" id="consumo" placeholder="Gasto Mensal (R$)" class="input-dark w-full px-4 py-4 rounded-2xl text-sm" onkeyup="formatarMoeda(this)">
                            <i class="fas fa-dollar-sign input-icon"></i>
                        </div>

                        <div class="input-wrapper">
                            <input type="email" id="email" placeholder="Seu E-mail" class="input-dark w-full px-4 py-4 rounded-2xl text-sm">
                            <i class="fas fa-envelope input-icon"></i>
                        </div>

                        <div class="input-wrapper">
                            <input type="tel" id="whatsapp" placeholder="WhatsApp" class="input-dark w-full px-4 py-4 rounded-2xl text-sm" oninput="mascaraTelefone(this)">
                            <i class="fab fa-whatsapp input-icon"></i>
                        </div>
                        
                        <input type="hidden" id="lat"> <input type="hidden" id="lng">

                        <button type="button" id="btnGerar" class="btn-yellow w-full py-5 rounded-2xl uppercase text-[11px] font-black tracking-widest">
                            Gerar Proposta Instantânea <i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </form>
                </div>

                <div id="msg-sucesso" class="hidden text-center animate-in fade-in zoom-in duration-500">
                    <div class="w-20 h-20 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-400 border border-blue-500/30">
                        <i class="fas fa-envelope-open-text text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Quase lá!</h2>
                    <p class="text-slate-300 text-sm mb-6 leading-relaxed">
                        Geramos sua proposta de alta precisão. Por segurança, enviamos um <strong>Link de Acesso</strong> para o seu e-mail.
                    </p>
                    <div class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-xl text-xs text-yellow-200 mb-6">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Verifique também a caixa de Spam.
                    </div>
                    <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Aguardando confirmação...</p>
                </div>

            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCpcQqXdDWtEW2wPsj9Z2dLdt_IzLLKWV8",
            authDomain: "pro-sollar-performance.firebaseapp.com",
            projectId: "pro-sollar-performance",
            storageBucket: "pro-sollar-performance.firebasestorage.app",
            messagingSenderId: "484051034820",
            appId: "1:484051034820:web:3cf21ee3ce55b9c5625f91"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- UTILITÁRIOS ---
        function formatarMoeda(i) { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2) + ''; v = v.replace(".", ","); v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); i.value = "R$ " + v; }
        function mascaraTelefone(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }
        
        // --- MOTOR DE ENGENHARIA V6.0 (ATUALIZADO COM TRAVA 80%) ---
        function calcularEngenhariaPrecisao(contaMensalReais, lat = -23.5) {
            // --- CONSTANTES DE ENGENHARIA ---
            const TARIFA_ATUAL = 0.96; 
            const PERDA_SISTEMA = 0.25; 
            const PERFORMANCE_RATIO = 1 - PERDA_SISTEMA;
            const POT_MODULO_W = 600;
            const AREA_MODULO_M2 = 1.13 * 2.38; 
            const DEGRADACAO_MENSAL = 0.00067; 
            const INFLACAO_ENERGETICA_MENSAL = 0.005; 

            const CURVA_SAZONAL = [1.20, 1.15, 1.05, 0.95, 0.85, 0.75, 0.80, 0.95, 1.00, 1.05, 1.10, 1.15];

            // Irradiação Solar
            let HSP_MEDIA_DIARIA = 4.85; 
            if (Math.abs(lat) > 25) HSP_MEDIA_DIARIA = 4.35; 
            if (Math.abs(lat) < 15) HSP_MEDIA_DIARIA = 5.30; 

            // 1. Dimensionamento do Sistema
            const consumoMensalKwh = contaMensalReais / TARIFA_ATUAL;
            let potenciaAlvoKwp = (consumoMensalKwh / (HSP_MEDIA_DIARIA * 30 * PERFORMANCE_RATIO)) * 1.10;

            const qtdModulos = Math.ceil((potenciaAlvoKwp * 1000) / POT_MODULO_W);
            const potenciaInstaladaKwp = (qtdModulos * POT_MODULO_W) / 1000;
            const areaTotalSistema = qtdModulos * AREA_MODULO_M2;

            // --- 2. CÁLCULO FINANCEIRO COM TRAVA DE 80% ---
            let fluxoCaixa = [];
            let geracaoAcumulada = 0;
            let economiaRealAcumulada = 0;
            let tarifaCorrente = TARIFA_ATUAL;
            let contaMensalProjetada = contaMensalReais;

            for (let i = 0; i < 300; i++) {
                const mesDoAno = i % 12;
                const anoCorrente = Math.floor(i / 12) + 1;
                const hspMes = HSP_MEDIA_DIARIA * CURVA_SAZONAL[mesDoAno];
                const fatorDegradacao = 1 - (i * DEGRADACAO_MENSAL);
                
                // Geração
                const geracaoMes = potenciaInstaladaKwp * hspMes * 30 * PERFORMANCE_RATIO * fatorDegradacao;
                const valorGeracaoBruta = geracaoMes * tarifaCorrente;

                // Teto de Economia (80% da Fatura do Mês)
                const tetoEconomia = contaMensalProjetada * 0.80;

                // Economia Real (Menor entre Gerado e Teto)
                const economiaRealMes = Math.min(valorGeracaoBruta, tetoEconomia);

                geracaoAcumulada += geracaoMes;
                economiaRealAcumulada += economiaRealMes;

                fluxoCaixa.push({
                    mes_absoluto: i + 1,
                    mes_ano: mesDoAno + 1,
                    ano: anoCorrente,
                    geracao_kwh: parseFloat(geracaoMes.toFixed(2)),
                    economia_reais: parseFloat(economiaRealMes.toFixed(2)),
                    economia_potencial: parseFloat(valorGeracaoBruta.toFixed(2)),
                    fluxo_acumulado: 0 
                });

                // Atualiza Índices
                tarifaCorrente = tarifaCorrente * (1 + INFLACAO_ENERGETICA_MENSAL);
                contaMensalProjetada = contaMensalProjetada * (1 + INFLACAO_ENERGETICA_MENSAL);
            }

            // --- 3. DEFINIÇÃO DO PREÇO (Baseado na Economia Real Média Ano 1) ---
            const economiaRealAno1 = fluxoCaixa.slice(0, 12).reduce((acc, mes) => acc + mes.economia_reais, 0);
            const mediaEconomiaRealMensal = economiaRealAno1 / 12;

            // Preço = (Economia Média Real * 25) * 1.40
            const COEFICIENTE_INVESTIMENTO = 1.40;
            const FATOR_RETORNO_BASE = 25;
            
            const investimentoTotal = (mediaEconomiaRealMensal * FATOR_RETORNO_BASE) * COEFICIENTE_INVESTIMENTO;

            // Recalcula fluxo acumulado
            let accFluxo = -investimentoTotal;
            fluxoCaixa.forEach(mes => {
                accFluxo += mes.economia_reais;
                mes.fluxo_acumulado = parseFloat(accFluxo.toFixed(2));
            });

            // Breakdown de Custos
            const custoKit = investimentoTotal * 0.52;        
            const custoInstalacao = investimentoTotal * 0.09; 
            const custoMateriais = investimentoTotal * 0.09;  
            const custoSeguro = investimentoTotal * 0.01;     
            const custoComissao = investimentoTotal * 0.03;   
            
            const valorTributavel = investimentoTotal - custoKit;
            const custoImposto = valorTributavel * 0.07;

            // Métricas
            const geracaoMediaAno1 = fluxoCaixa.slice(0, 12).reduce((a, b) => a + b.geracao_kwh, 0) / 12;
            const mesPayback = fluxoCaixa.findIndex(m => m.fluxo_acumulado >= 0);
            const paybackAnos = mesPayback !== -1 ? (mesPayback + 1) / 12 : 0;

            return {
                engenharia: {
                    projetado: {
                        potencia_instalada_kwp: potenciaInstaladaKwp.toFixed(2),
                        qtd_modulos: qtdModulos,
                        geracao_mensal_media_ano1: Math.round(geracaoMediaAno1),
                        area_ocupada_m2: areaTotalSistema.toFixed(1),
                        hsp_media_utilizada: HSP_MEDIA_DIARIA
                    },
                    parametros: {
                        perda_sistema: "25%",
                        degradacao_mensal: "0.067%",
                        modulo_potencia: "600W"
                    }
                },
                configuracao_sistema: {
                    modulo: { modelo: `Módulo High-Power 600W`, potencia: 600, dimensoes: "1.13m x 2.38m" },
                    inversor: { tipo: "Inversor String Inteligente" }
                },
                financeiro: {
                    investimento_bruto: parseFloat(investimentoTotal.toFixed(2)),
                    valor_final: parseFloat(investimentoTotal.toFixed(2)),
                    economia_total_acumulada: parseFloat(economiaRealAcumulada.toFixed(2)),
                    payback_anos: parseFloat(paybackAnos.toFixed(1)),
                    fluxo_caixa_mensal: fluxoCaixa,
                    composicao_preco: {
                        coeficiente_utilizado: COEFICIENTE_INVESTIMENTO,
                        kit_solar: parseFloat(custoKit.toFixed(2)),
                        instalacao: parseFloat(custoInstalacao.toFixed(2)),
                        materiais_eletricos: parseFloat(custoMateriais.toFixed(2)),
                        seguro: parseFloat(custoSeguro.toFixed(2)),
                        comissao: parseFloat(custoComissao.toFixed(2)),
                        impostos: parseFloat(custoImposto.toFixed(2)),
                        valor_tributavel: parseFloat(valorTributavel.toFixed(2))
                    }
                }
            };
        }

        // --- 4. AÇÃO PRINCIPAL: GERAR PROPOSTA E CRIAR NOVO ID ---
        document.getElementById('btnGerar').addEventListener('click', async function() {
            const email = document.getElementById('email').value;
            const zap = document.getElementById('whatsapp').value;
            const endereco = document.getElementById('endereco').value;
            const consumoRaw = document.getElementById('consumo').value;
            const lat = document.getElementById('lat').value || "-23.55"; 

            if (!email || !zap || !consumoRaw || !endereco) { alert("Preencha todos os campos."); return; }

            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verificando...';
            btn.disabled = true;

            try {
                // REF AO USUÁRIO PAI
                const userRef = db.collection("leads").doc(email);

                // 1. VERIFICAR LIMITE DE 3 PROJETOS
                const snapshot = await userRef.collection("simulacoes").get();
                if (snapshot.size >= 3) {
                    alert("Você já atingiu o limite de 3 simulações gratuitas.\n\nAcesse seu painel para ver os projetos existentes.");
                    
                    const actionCodeSettings = { url: window.location.origin + `/login.html?email=${encodeURIComponent(email)}`, handleCodeInApp: true };
                    await auth.sendSignInLinkToEmail(email, actionCodeSettings);
                    window.localStorage.setItem('emailForSignIn', email);
                    
                    document.getElementById('form-container').classList.add('hidden');
                    document.getElementById('msg-sucesso').classList.remove('hidden');
                    return;
                }

                btn.innerHTML = '<i class="fas fa-satellite-dish fa-spin"></i> Calculando...';

                // 2. CÁLCULO
                const consumoLimpo = parseFloat(consumoRaw.replace(/[^0-9,]/g, '').replace(',', '.'));
                const dadosCompletos = calcularEngenhariaPrecisao(consumoLimpo, parseFloat(lat));
                const nomeProjeto = endereco.split(',')[0].substring(0, 25);

                // 3. GRAVA DADOS DO PERFIL NA RAIZ (PAI)
                await userRef.set({
                    perfil: {
                        email: email,
                        whatsapp_formatted: zap,
                        ultimo_acesso: firebase.firestore.FieldValue.serverTimestamp()
                    }
                }, { merge: true });

                // 4. GRAVA A SIMULAÇÃO NA SUB-COLEÇÃO (FILHO)
                const simDoc = await userRef.collection("simulacoes").add({
                    engenharia: dadosCompletos.engenharia,
                    configuracao_sistema: dadosCompletos.configuracao_sistema,
                    financeiro: dadosCompletos.financeiro,
                    detalhes: {
                        endereco_completo: endereco,
                        nome_projeto: nomeProjeto,
                        consumo_simulado: consumoLimpo
                    },
                    data_criacao: firebase.firestore.FieldValue.serverTimestamp(),
                    status: { fase: 'nova_simulacao', desconto_aplicado: false }
                });

                // 5. ENVIAR LINK DE ACESSO
                const actionCodeSettings = { url: window.location.origin + `/login.html?email=${encodeURIComponent(email)}`, handleCodeInApp: true };
                await auth.sendSignInLinkToEmail(email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);

                // 6. SUCESSO (SEM REDIRECIONAR AUTOMATICAMENTE)
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('msg-sucesso').classList.remove('hidden');
                
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- GOOGLE PLACES ---
        window.initAutocomplete = function() {
            const autocomplete = new google.maps.places.Autocomplete(document.getElementById('endereco'), {
                componentRestrictions: { country: "br" },
                fields: ["geometry", "formatted_address"],
                types: ["address"]
            });
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    document.getElementById('lat').value = place.geometry.location.lat();
                    document.getElementById('lng').value = place.geometry.location.lng();
                }
            });
        };
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJ6SKOgB0TpR9d6XF1WmsRcHVQZG4tjrU&libraries=places&callback=initAutocomplete" async defer></script>
</body>
</html>
