<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Pro-Sollar | Formaliza√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');
        :root { --bg-deep: #0a1120; --accent-blue: #3b82f6; --accent-green: #22c55e; --accent-yellow: #facc15; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-deep); color: white; min-height: 100vh; background-image: radial-gradient(circle at 10% 10%, rgba(34, 197, 94, 0.1) 0%, transparent 40%), radial-gradient(circle at 90% 90%, rgba(59, 130, 246, 0.1) 0%, transparent 40%); background-attachment: fixed; }
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 2rem; }
        .input-dark { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s; color-scheme: dark; }
        .input-dark:focus { border-color: var(--accent-blue); outline: none; background: rgba(0, 0, 0, 0.5); }
        ::-webkit-calendar-picker-indicator { filter: invert(0.6); opacity: 0.8; cursor: pointer; transition: 0.3s; }
        ::-webkit-calendar-picker-indicator:hover { opacity: 1; filter: invert(0.8); }
        .btn-confirm { background: linear-gradient(135deg, var(--accent-green) 0%, #15803d 100%); box-shadow: 0 0 25px rgba(34, 197, 94, 0.4); transition: all 0.3s; }
        .btn-confirm:hover { transform: scale(1.02); box-shadow: 0 0 40px rgba(34, 197, 94, 0.6); }
        .transparency-card { background: rgba(59, 130, 246, 0.05); border: 1px dashed rgba(59, 130, 246, 0.3); border-radius: 1.5rem; }
        .equip-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; }
        .equip-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--accent-green); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <header class="flex items-center gap-4 mb-8 cursor-pointer" onclick="voltarParaPainel()">
            <div class="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center hover:bg-white/10 transition"><i class="fas fa-arrow-left text-slate-400"></i></div>
            <h1 class="text-xl font-bold text-slate-300">Voltar para Negocia√ß√£o</h1>
        </header>

        <div id="loading-skeleton" class="glass-card p-12 text-center">
            <i class="fas fa-circle-notch fa-spin text-3xl text-blue-500 mb-4"></i>
            <p class="text-slate-400">Carregando termos da proposta...</p>
        </div>

        <div id="checkout-content" class="hidden grid lg:grid-cols-5 gap-8 animate-in fade-in duration-700">
            <div class="lg:col-span-3 space-y-6">
                <div class="glass-card p-8 border-l-4 border-l-green-500">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-sm font-black uppercase tracking-widest text-slate-500">Composi√ß√£o do Sistema</h2><span class="bg-green-500/10 text-green-400 text-[10px] font-bold px-3 py-1 rounded-full border border-green-500/20 uppercase tracking-wide">Pr√©-Aprovado</span></div>
                    <div class="space-y-3 mb-8">
                        <div class="equip-item"><div class="w-10 h-10 bg-yellow-500/10 rounded-lg flex items-center justify-center text-yellow-500"><i class="fas fa-solar-panel text-lg"></i></div><div><p id="panel-model" class="text-sm font-bold text-white">Carregando...</p><div class="flex gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-400 mt-0.5 flex-wrap"><span class="text-green-400">25 Anos Performance</span><span>‚Ä¢</span><span>12 Anos Produto</span></div></div></div>
                        <div class="equip-item"><div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center text-blue-400"><i class="fas fa-microchip text-lg"></i></div><div><p class="text-sm font-bold text-white">Inversor Inteligente</p><div class="flex gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-400 mt-0.5"><span class="text-blue-300">Garantia Estendida</span><span>‚Ä¢</span><span>Wi-Fi Incluso</span></div></div></div>
                        <div class="equip-item"><div class="w-10 h-10 bg-purple-500/10 rounded-lg flex items-center justify-center text-purple-400"><i class="fas fa-file-contract text-lg"></i></div><div><p class="text-sm font-bold text-white">Seguro Risco Engenharia</p><div class="flex gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-400 mt-0.5"><span class="text-purple-300">1 Ano Incluso</span><span>‚Ä¢</span><span>Instala√ß√£o Segura</span></div></div></div>
                    </div>
                    <div class="pt-6 border-t border-white/5 flex justify-between items-end"><div><p class="text-xs text-slate-500 mb-1">Local de Instala√ß√£o</p><p id="install-address" class="text-sm font-medium text-white max-w-xs">...</p></div><div class="text-right"><p id="price-label" class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-1">Investimento Total</p><p id="final-price" class="text-3xl font-black text-green-400">R$ --</p></div></div>
                </div>
                <div class="glass-card p-8">
                    <h2 class="text-sm font-black uppercase tracking-widest text-slate-500 mb-6">Canais de Contato</h2>
                    <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] text-slate-400 uppercase font-bold">E-mail</label><p id="client-email" class="text-white font-medium">...</p></div><div><label class="text-[10px] text-slate-400 uppercase font-bold">WhatsApp</label><p id="client-phone" class="text-white font-medium">...</p></div></div>
                </div>
            </div>
            <div class="lg:col-span-2 space-y-6">
                <div class="transparency-card p-6"><div class="flex items-center gap-3 mb-3"><i class="fas fa-shield-alt text-blue-400 text-xl"></i><h3 class="text-sm font-bold text-white">Transpar√™ncia Total</h3></div><p class="text-xs text-slate-400 leading-relaxed text-justify">Este valor √© baseado em dados de sat√©lite. Ap√≥s o agendamento, nossa engenharia far√° uma <strong class="text-white">Valida√ß√£o T√©cnica Presencial</strong> no seu im√≥vel.</p></div>
                <div class="glass-card p-8 relative overflow-hidden">
                    <form id="booking-form">
                        <div>
                            <h2 class="text-xl font-bold text-white mb-2">Dados da Visita</h2>
                            <p class="text-xs text-slate-400 mb-6">Informe quem ir√° receber nossa equipe t√©cnica.</p>
                            <div class="space-y-4">
                                <div><label class="text-xs font-bold text-slate-300 ml-1 block mb-2">Nome Completo</label><div class="relative"><i class="fas fa-user absolute left-4 top-3.5 text-slate-500 text-sm"></i><input type="text" id="titular-nome" required class="input-dark w-full pl-10 pr-4 py-3 rounded-xl text-sm placeholder-slate-500"></div></div>
                                <div class="pl-1"><label class="flex items-center gap-3 cursor-pointer group"><div class="relative flex items-center"><input type="checkbox" id="check-mesmo-nome" checked onchange="toggleRecebedor()" class="peer h-4 w-4 cursor-pointer appearance-none rounded border border-slate-600 bg-slate-900/50 checked:border-blue-500 checked:bg-blue-500 transition-all"><i class="fas fa-check text-white text-[10px] absolute left-0.5 top-0.5 opacity-0 peer-checked:opacity-100"></i></div><span class="text-xs text-slate-400 group-hover:text-white transition">Eu mesmo receberei a visita</span></label></div>
                                <div id="campo-recebedor" class="hidden animate-in fade-in slide-in-from-top-2 duration-300"><label class="text-xs font-bold text-yellow-500 ml-1 block mb-2">Quem receber√° a equipe?</label><div class="relative"><i class="fas fa-user-friends absolute left-4 top-3.5 text-slate-500 text-sm"></i><input type="text" id="recebedor-nome" placeholder="Ex: Portaria" class="input-dark w-full pl-10 pr-4 py-3 rounded-xl text-sm placeholder-slate-500 border-yellow-500/50 focus:border-yellow-500"></div></div>
                                <div><label class="text-xs font-bold text-slate-300 ml-1 block mb-2">Data da Visita</label><input type="date" id="visit-date" required class="input-dark w-full px-4 py-3 rounded-xl text-sm"></div>
                                <div><label class="text-xs font-bold text-slate-300 ml-1 block mb-2">Per√≠odo</label><div class="grid grid-cols-2 gap-3"><label class="cursor-pointer"><input type="radio" name="periodo" value="manha" class="peer hidden" checked><div class="bg-black/20 border border-white/10 peer-checked:border-green-500 peer-checked:bg-green-500/20 rounded-xl py-3 text-center text-xs font-bold text-slate-400 peer-checked:text-green-400 transition-all"><i class="fas fa-sun mr-2"></i>Manh√£</div></label><label class="cursor-pointer"><input type="radio" name="periodo" value="tarde" class="peer hidden"><div class="bg-black/20 border border-white/10 peer-checked:border-green-500 peer-checked:bg-green-500/20 rounded-xl py-3 text-center text-xs font-bold text-slate-400 peer-checked:text-green-400 transition-all"><i class="fas fa-cloud-sun mr-2"></i>Tarde</div></label></div></div>
                            </div>
                        </div>
                        <div class="mt-8 space-y-4">
                            <label class="flex items-start gap-3 cursor-pointer group"><div class="relative flex items-center mt-1"><input type="checkbox" id="terms" required class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-slate-600 bg-slate-900/50 checked:border-green-500 checked:bg-green-500 transition-all"><i class="fas fa-check text-black text-[10px] absolute left-1 top-1 opacity-0 peer-checked:opacity-100"></i></div><span class="text-xs text-slate-400 leading-tight group-hover:text-slate-300 transition text-justify">Autorizo a visita t√©cnica e estou ciente de que a <strong>Proposta Comercial Definitiva</strong> depender√° da valida√ß√£o das condi√ß√µes do telhado e rede el√©trica.</span></label>
                            <button type="submit" id="btn-submit" class="btn-confirm w-full py-4 rounded-xl text-sm font-black uppercase tracking-widest flex items-center justify-center gap-3 text-white">Reservar e Agendar <i class="fas fa-calendar-check"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="success-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
            <div class="glass-card p-10 max-w-md text-center mx-4 animate-bounce-in border border-green-500/30">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_40px_rgba(34,197,94,0.4)]"><i class="fas fa-check text-4xl text-white"></i></div>
                <h2 class="text-2xl font-bold text-white mb-2">Visita Agendada!</h2>
                <p class="text-slate-300 text-sm mb-6 leading-relaxed">Sua reserva de pre√ßo foi realizada com sucesso. Enviamos a proposta detalhada para seu e-mail.</p>
                <button onclick="voltarParaPainel()" class="bg-white/10 border border-white/20 hover:bg-white/20 text-white w-full py-3 rounded-xl text-xs font-bold uppercase tracking-widest transition">Voltar ao Painel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>

    <script>
        console.log("üöÄ Script de Checkout Iniciado");

        const firebaseConfig = {
            apiKey: "AIzaSyCpcQqXdDWtEW2wPsj9Z2dLdt_IzLLKWV8",
            authDomain: "pro-sollar-performance.firebaseapp.com",
            projectId: "pro-sollar-performance",
            storageBucket: "pro-sollar-performance.firebasestorage.app",
            messagingSenderId: "484051034820",
            appId: "1:484051034820:web:3cf21ee3ce55b9c5625f91"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentEmail, currentSimId, leadData;
        
        // Configura√ß√£o de Data M√≠nima
        const dateInput = document.getElementById('visit-date');
        if(dateInput) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.min = tomorrow.toISOString().split('T')[0];
        }

        // --- FUN√á√ïES DE INTERFACE ---
        window.toggleRecebedor = function() {
            const check = document.getElementById('check-mesmo-nome');
            const campo = document.getElementById('campo-recebedor');
            const input = document.getElementById('recebedor-nome');
            
            if(check.checked) {
                campo.classList.add('hidden');
                input.required = false;
                input.value = "";
            } else {
                campo.classList.remove('hidden');
                input.required = true;
                input.focus();
            }
        }

        window.voltarParaPainel = function() {
            if(currentEmail && currentSimId) {
                window.location.href = `panel.html?email=${encodeURIComponent(currentEmail)}&simId=${currentSimId}`;
            } else {
                window.history.back();
            }
        }

        // --- CARREGAMENTO DE DADOS ---
        auth.onAuthStateChanged(async (user) => {
            console.log("Auth State Changed:", user ? "Logado" : "N√£o Logado");
            const params = new URLSearchParams(window.location.search);
            const urlEmail = params.get('email');
            const urlSimId = params.get('simId') || params.get('id');

            if (urlEmail && urlSimId) {
                currentEmail = urlEmail;
                currentSimId = urlSimId;
            } else if (user) {
                currentEmail = user.email;
                // Se estiver logado mas sem ID na URL, volta pro painel
                if(!urlSimId) {
                    window.location.href = "panel.html";
                    return;
                }
            } else {
                alert("Link inv√°lido ou expirado.");
                window.location.href = "login.html";
                return;
            }

            if(currentEmail && currentSimId) {
                await carregarDados(currentEmail, currentSimId);
            }
        });

        async function carregarDados(email, simId) {
            try {
                console.log("Buscando dados...", email, simId);
                const simRef = db.collection("leads").doc(email).collection("simulacoes").doc(simId);
                const userRef = db.collection("leads").doc(email);

                const simSnap = await simRef.get();
                const userSnap = await userRef.get();

                if (simSnap.exists) {
                    const simData = simSnap.data();
                    const userData = userSnap.exists ? userSnap.data() : {};
                    
                    // Mescla os dados para uso global
                    leadData = {
                        ...userData,
                        ...simData,
                        id: simId,
                        email: email,
                        perfil: { ...userData.perfil, ...(simData.perfil || {}) }
                    };
                    
                    renderizar(leadData);
                } else {
                    alert("Simula√ß√£o n√£o encontrada.");
                    window.location.href = "panel.html";
                }
            } catch (error) {
                console.error("Erro ao carregar:", error);
                alert("Erro de conex√£o ao buscar dados.");
            }
        }

        function renderizar(data) {
            const engenharia = data.engenharia?.projetado || {};
            const config = data.configuracao_sistema || {};
            const financeiro = data.financeiro || {};
            const detalhes = data.detalhes || {};
            const perfil = data.perfil || {};

            document.getElementById('panel-model').innerText = `${engenharia.qtd_modulos || 0}x ${config.modulo?.modelo || "M√≥dulos"} (${engenharia.potencia_instalada_kwp || "0"} kWp)`;
            document.getElementById('install-address').innerText = detalhes.endereco_completo || perfil.endereco_completo || "Local n√£o informado";

            const valorPadrao = financeiro.investimento_bruto || 0;
            const isDiscount = data.status?.desconto_aplicado || false;
            let valorExibir = isDiscount ? valorPadrao * 0.95 : valorPadrao;
            
            const priceLabel = document.getElementById('price-label');
            if (isDiscount) {
                priceLabel.innerText = "Valor Promocional (√Ä Vista)";
                priceLabel.classList.add('text-green-500');
            } else {
                priceLabel.innerText = "Valor Padr√£o (Financi√°vel)";
                priceLabel.classList.remove('text-green-500');
            }

            document.getElementById('final-price').innerText = valorExibir.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('client-email').innerText = currentEmail || data.email;
            document.getElementById('client-phone').innerText = perfil.whatsapp_formatted || perfil.whatsapp || "Via WhatsApp";
            
            if(perfil.nome) document.getElementById('titular-nome').value = perfil.nome;

            document.getElementById('loading-skeleton').classList.add('hidden');
            document.getElementById('checkout-content').classList.remove('hidden');
        }

        // --- DESIGN: LIGHT MODE (Fundo Branco Clean) ---
        function gerarHtmlEmail(dados) {
            
            const LOGO_URL = "https://firebasestorage.googleapis.com/v0/b/pro-sollar-performance.firebasestorage.app/o/Pr%C3%B3-Sollar%20Engenharia%20Apresenta%C3%A7%C3%A3o.png?alt=media&token=640b3321-e58f-44f9-8d93-5e48aa86c830"; 

            const c = {
                bg: '#ffffff',         // Fundo Branco Puro
                card: '#ffffff',       // Cart√£o Branco
                glass: '#f8fafc',      // Cinza muito suave (para separar blocos)
                border: '#e2e8f0',     // Borda cinza clara
                text: '#0f172a',       // Texto Preto (Azul muito escuro para leitura)
                muted: '#64748b',      // Cinza m√©dio
                accent: '#16a34a',     // Verde (um pouco mais escuro para ler no branco)
                blue: '#2563eb'        // Azul forte
            };

            return `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    @media only screen and (max-width: 600px) {
                        .col-split { display: block !important; width: 100% !important; padding-left: 0 !important; padding-right: 0 !important; margin-bottom: 20px !important; border-right: none !important; }
                    }
                </style>
            </head>
            <body style="margin: 0; padding: 0; background-color: ${c.bg}; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: ${c.glass}; padding: 40px 0;">
                    <tr>
                        <td align="center">
                            
                            <table width="600" border="0" cellspacing="0" cellpadding="0" style="max-width: 600px; width: 100%; margin: 0 auto; background-color: ${c.card}; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid ${c.border};">
                                
                                <tr>
                                    <td style="padding: 40px 40px 0 40px; text-align: center;">
                                        <img src="${LOGO_URL}" alt="Pro-Sollar" width="90" style="display: block; margin: 0 auto; border-radius: 50%;">
                                        <div style="margin-top: 20px;">
                                            <span style="background-color: #dcfce7; color: ${c.accent}; font-size: 10px; font-weight: bold; padding: 6px 12px; rounded-full; border-radius: 20px; letter-spacing: 1px; font-family: sans-serif;">
                                                AGENDAMENTO CONFIRMADO
                                            </span>
                                        </div>
                                    </td>
                                </tr>

                                <tr>
                                    <td style="padding: 30px 40px;">
                                        <h1 style="color: ${c.text}; font-size: 24px; margin: 0 0 10px 0; font-weight: 700; text-align: center;">Ol√°, ${dados.nome}.</h1>
                                        <p style="color: ${c.muted}; font-size: 16px; margin: 0; line-height: 1.6; text-align: center;">
                                            Tudo pronto! Sua visita t√©cnica foi pr√©-agendada. Nossa engenharia j√° est√° preparando a documenta√ß√£o.
                                        </p>
                                    </td>
                                </tr>

                                <tr>
                                    <td style="padding: 0 40px 40px 40px;">
                                        <div style="background-color: ${c.glass}; border: 1px solid ${c.border}; border-radius: 12px; padding: 30px;">
                                            
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 25px; border-bottom: 1px dashed ${c.border}; padding-bottom: 25px;">
                                                <tr>
                                                    <td width="50%" valign="top">
                                                        <p style="color: ${c.muted}; font-size: 10px; text-transform: uppercase; font-weight: bold; margin: 0;">Data da Visita</p>
                                                        <p style="color: ${c.text}; font-size: 16px; font-weight: 600; margin: 5px 0 0 0;">${dados.data}</p>
                                                        <p style="color: ${c.blue}; font-size: 12px; font-weight: 500; margin: 2px 0 0 0;">Per√≠odo: ${dados.periodo}</p>
                                                    </td>
                                                    <td width="50%" valign="top">
                                                        <p style="color: ${c.muted}; font-size: 10px; text-transform: uppercase; font-weight: bold; margin: 0;">Local</p>
                                                        <p style="color: ${c.text}; font-size: 14px; line-height: 1.4; margin: 5px 0 0 0;">${dados.endereco}</p>
                                                    </td>
                                                </tr>
                                            </table>

                                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                <tr>
                                                    <td align="center">
                                                        <p style="color: ${c.muted}; font-size: 10px; text-transform: uppercase; font-weight: bold; margin: 0;">Investimento Reservado</p>
                                                        <p style="color: ${c.accent}; font-size: 28px; font-weight: 800; margin: 5px 0; letter-spacing: -1px;">${dados.valor}</p>
                                                        <p style="background-color: #fff; border: 1px solid ${c.border}; display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: ${c.text}; margin: 0;">
                                                            Condi√ß√£o: <strong>${dados.condicao}</strong>
                                                        </p>
                                                    </td>
                                                </tr>
                                            </table>

                                        </div>
                                    </td>
                                </tr>

                                <tr>
                                    <td align="center" style="padding-bottom: 40px; border-top: 1px solid ${c.border}; padding-top: 30px;">
                                        <p style="font-size: 12px; color: ${c.muted}; margin: 0; line-height: 1.5;">
                                            ‚ö†Ô∏è <strong>Importante:</strong> A proposta definitiva depende da<br>valida√ß√£o t√©cnica presencial no im√≥vel.
                                        </p>
                                        <p style="font-size: 11px; color: #cbd5e1; margin-top: 20px;">
                                            ¬© 2026 Pro-Sollar Engenharia.
                                        </p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                </table>
            </body>
            </html>
            `;
        }

        // --- OUVINTE DE EVENTO (CORRE√á√ÉO CR√çTICA) ---
        // Aqui garantimos que o form seja controlado pelo JS
        document.getElementById('booking-form').addEventListener('submit', async function(e) {
            e.preventDefault(); // Impede o reload da p√°gina
            console.log("Bot√£o Reservar Clicado!");

            // Verifica se os dados carregaram
            if (!leadData) {
                alert("Aguarde o carregamento completo dos dados.");
                return;
            }

            const btn = document.getElementById('btn-submit');
            const originalHTML = btn.innerHTML;
            
            // Trava o bot√£o
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> Processando...';

            try {
                // Coleta dados do formul√°rio
                const nomeTitular = document.getElementById('titular-nome').value;
                const isMesmoNome = document.getElementById('check-mesmo-nome').checked;
                const nomeRecebedor = isMesmoNome ? nomeTitular : document.getElementById('recebedor-nome').value;
                const dataVisita = document.getElementById('visit-date').value;
                
                // Pega o radio button selecionado com seguran√ßa
                const periodoEl = document.querySelector('input[name="periodo"]:checked');
                const periodo = periodoEl ? periodoEl.value : "manha";

                // Formata√ß√£o
                const dataObj = new Date(dataVisita);
                // Ajuste de timezone simples para exibi√ß√£o
                const dataFormatada = new Date(dataObj.valueOf() + dataObj.getTimezoneOffset() * 60000).toLocaleDateString('pt-BR');
                
                const valorFinalTexto = document.getElementById('final-price').innerText;
                const condicaoTexto = leadData.status?.desconto_aplicado ? "√Ä Vista" : "Financiado";
                const enderecoTexto = document.getElementById('install-address').innerText;

                console.log("Dados coletados, enviando para Firestore...");

                // 1. Atualiza Perfil
                await db.collection("leads").doc(currentEmail).update({ 
                    "perfil.nome": nomeTitular 
                });

                // 2. Atualiza Simula√ß√£o
                await db.collection("leads").doc(currentEmail).collection("simulacoes").doc(currentSimId).update({
                    "status.fase": "visita_agendada", 
                    "status.data_fechamento_site": firebase.firestore.FieldValue.serverTimestamp(),
                    "agendamento": { 
                        responsavel_local: nomeRecebedor, 
                        data_visita: dataVisita, 
                        periodo: periodo, 
                        status: "pendente_confirmacao", 
                        termo_aceite: true 
                    },
                    "fechamento": { 
                        valor_reservado: valorFinalTexto, 
                        condicao: leadData.status?.desconto_aplicado ? "a_vista" : "financiado" 
                    }
                });

                // 3. Cria E-mail na Fila (TRIGGER DO BACKEND)
                const htmlContent = gerarHtmlEmail({
                    nome: nomeTitular,
                    data: dataFormatada,
                    periodo: periodo === 'manha' ? 'Manh√£' : 'Tarde',
                    endereco: enderecoTexto,
                    valor: valorFinalTexto,
                    condicao: condicaoTexto
                });

                await db.collection("fila_email").add({
                    to: currentEmail,
                    message: {
                        subject: `Confirma√ß√£o de Agendamento - Pro-Sollar`,
                        html: htmlContent 
                    },
                    status: "PENDENTE", // Importante para debug
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log("Sucesso! Mostrando modal.");
                document.getElementById('success-modal').classList.remove('hidden');

            } catch (error) {
                console.error("ERRO FATAL:", error);
                alert("Erro ao processar agendamento: " + error.message);
                
                // Destrava o bot√£o em caso de erro
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        });
    </script>
</body>
</html>
