<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Sollar | Portal da Independência Energética</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');

        :root {
            --bg-deep: #0a1120;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #facc15;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(34, 197, 94, 0.05) 0%, transparent 30%);
            background-attachment: fixed;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Botões de Ação */
        .btn-approve {
            background: var(--accent-green);
            color: #052e16;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2);
            transition: all 0.3s ease;
        }
        .btn-approve:hover {
            transform: scale(1.02) translateY(-2px);
            box-shadow: 0 15px 40px rgba(34, 197, 94, 0.4);
            background: #4ade80;
        }

        .btn-negotiate-action {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .btn-negotiate-action:hover {
            transform: scale(1.02) translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.5);
            background: #60a5fa;
        }

        .negotiation-btn {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .negotiation-btn:hover {
            border-color: var(--accent-yellow);
            background: rgba(250, 204, 21, 0.05);
        }
        .negotiation-btn.active {
            border-color: var(--accent-green);
            background: rgba(34, 197, 94, 0.08);
        }
        
        .chart-container { position: relative; height: 320px; width: 100%; }

        /* Chart Controls */
        .chart-toggle {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 4px;
            display: inline-flex;
            margin-bottom: 20px;
        }
        .toggle-btn {
            padding: 8px 20px;
            border-radius: 0.8rem;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            color: #64748b;
            cursor: pointer;
        }
        .toggle-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .toggle-btn.active-green {
            background: var(--accent-green);
            color: #064e3b;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .time-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        .time-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .time-btn.active {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: white;
            box-shadow: 0 0 10px rgba(255,255,255,0.05);
        }
        .hidden-important { display: none !important; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--accent-blue); cursor: pointer; margin-top: -6px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: rgba(255,255,255,0.1); border-radius: 2px;
        }
        
        .control-group label { font-size: 10px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.1em; color: #93c5fd; }
        .control-value { font-size: 14px; font-weight: 900; color: white; }
        .upload-area { cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { background: rgba(250, 204, 21, 0.1); border-color: var(--accent-yellow); }
    </style>
</head>
<body class="p-4 md:p-10 lg:p-16">

    <div class="max-w-6xl mx-auto">
        
        <header class="flex justify-between items-center mb-12">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl flex items-center justify-center shadow-2xl">
                    <i class="fas fa-solar-panel text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter italic leading-none">Pro-<span class="text-blue-500">Sollar</span></h1>
                </div>
            </div>
            <div class="glass-card px-5 py-2 flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Conectado como</p>
                    <p id="user-email-display" class="text-xs font-bold text-blue-400">...</p>
                </div>
                <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="loading-skeleton" class="animate-pulse glass-card p-12 mb-8 text-center">
            <i class="fas fa-satellite-dish fa-spin text-4xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-bold">Calculando viabilidade...</h2>
        </div>

        <div id="content-panel" class="hidden animate-in fade-in duration-700">
            
            <div class="glass-card p-8 md:p-10 border-blue-500/20 bg-blue-500/[0.02] mb-8">
                <div class="flex flex-wrap justify-between items-start gap-6">
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-[10px] font-black uppercase tracking-[0.3em] text-green-500">Projeto Aprovado</span>
                        </div>
                        <h3 id="display-address" class="text-2xl md:text-3xl font-black italic text-white mb-2 leading-tight">...</h3>
                        <p id="display-specs" class="text-xs text-slate-400 font-bold uppercase tracking-widest">...</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest mb-1">Valor do Sistema</p>
                        <p id="display-price" class="text-3xl md:text-4xl font-black text-white italic">R$ --.--</p>
                        <p id="savings-badge" class="hidden text-[10px] text-green-500 font-bold uppercase tracking-widest mt-1">Desconto aplicado</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card p-6 text-center border-white/5">
                    <i class="fas fa-bolt text-yellow-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Geração Mês</p>
                    <p id="kpi-generation" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="glass-card p-6 text-center border-white/5">
                    <i class="fas fa-wallet text-blue-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Economia 1º Ano</p>
                    <p id="kpi-economy" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="glass-card p-6 text-center border-white/5">
                    <i class="fas fa-hourglass-half text-purple-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Payback</p>
                    <p id="kpi-payback" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="glass-card p-6 text-center border-green-500/20 bg-green-500/5">
                    <i class="fas fa-piggy-bank text-green-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-green-300 font-black uppercase tracking-widest">Lucro 25 Anos</p>
                    <p id="kpi-roi" class="text-lg font-black text-green-400">--</p>
                </div>
            </div>

            <div class="glass-card p-8 mb-8 relative overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white mb-4 md:mb-0"><i class="fas fa-chart-line text-blue-500 mr-2"></i> Análise Financeira</h3>
                    
                    <div class="chart-toggle">
                        <div id="mode-cash" onclick="window.switchChartMode('cash')" class="toggle-btn active-green">À Vista</div>
                        <div id="mode-finan" onclick="window.switchChartMode('finan')" class="toggle-btn">Financiado</div>
                    </div>
                </div>

                <div id="finan-controls" class="hidden mb-6 bg-blue-500/10 border border-blue-500/20 p-5 rounded-xl space-y-4">
                    <div class="control-group">
                        <div class="flex justify-between items-center mb-2">
                            <label><i class="fas fa-percentage mr-2"></i>Taxa de Juros (a.m.)</label>
                            <span id="rate-display" class="control-value">1.50%</span>
                        </div>
                        <input type="range" id="rate-slider" min="0.50" max="3.50" step="0.01" value="1.50" oninput="window.updateInterestRate(this.value)">
                    </div>
                    <div class="control-group border-t border-blue-500/20 pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <label><i class="fas fa-calendar-alt mr-2"></i>Prazo de Pagamento</label>
                            <span id="term-display" class="control-value">60x</span>
                        </div>
                        <input type="range" id="term-slider" min="12" max="84" step="12" value="60" oninput="window.updateLoanTerm(this.value)">
                    </div>
                </div>

                <p id="chart-desc" class="text-center text-xs text-slate-400 mb-6 font-medium">
                    Comparativo de Acúmulo de Patrimônio vs CDI (Renda Fixa)
                </p>

                <div class="chart-container">
                    <canvas id="wealthChart"></canvas>
                </div>

                <div class="time-selector">
                    <div id="time-1" onclick="window.switchTimeRange(1)" class="time-btn hidden-important">1 ANO</div>
                    <div id="time-5" onclick="window.switchTimeRange(5)" class="time-btn">5 ANOS</div>
                    <div id="time-15" onclick="window.switchTimeRange(15)" class="time-btn">15 ANOS</div>
                    <div id="time-25" onclick="window.switchTimeRange(25)" class="time-btn active">25 ANOS</div>
                </div>
            </div>

            <div class="pt-8 border-t border-white/5">
                <div class="flex flex-wrap gap-4 mb-8">
                    <button id="btn-discount" onclick="window.toggleDiscount()" class="negotiation-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all w-full sm:w-auto">
                        <i class="fas fa-tag mr-2 text-yellow-500"></i> Desconto à Vista
                    </button>
                    <button id="btn-challenge" onclick="window.toggleUpload()" class="negotiation-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest w-full sm:w-auto">
                        <i class="fas fa-handshake mr-2 text-blue-500"></i> Cobrir Concorrente
                    </button>
                </div>

                <div id="comp-upload" class="hidden animate-in fade-in duration-500 mb-8 p-8 rounded-3xl bg-yellow-500/5 border border-yellow-500/10 upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="text-center">
                        <i id="upload-icon" class="fas fa-cloud-upload-alt text-4xl text-yellow-500 mb-4"></i>
                        <p id="upload-text" class="text-sm font-bold text-white mb-2">Clique para anexar a proposta (PDF)</p>
                        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Nossa engenharia fará a equiparação técnica.</p>
                        <input type="file" id="file-input" accept="application/pdf" class="hidden" onchange="window.handleFileSelect(this)">
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row items-center justify-between gap-8 mt-10">
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 glass-card rounded-2xl flex items-center justify-center border-blue-500/20">
                            <i id="status-icon" class="fas fa-file-contract text-blue-500 text-xl"></i>
                        </div>
                        <div>
                            <p id="status-title" class="text-sm font-bold text-white italic">Tudo pronto para economizar?</p>
                            <p id="footer-text" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1 italic">Condição padrão selecionada</p>
                        </div>
                    </div>
                    
                    <button id="btn-final-action" class="btn-approve w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4">
                        Aprovar e Agendar Visita <i class="fas fa-calendar-check text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center py-10 opacity-30 border-t border-white/5 mt-12">
            <p class="text-[9px] font-black uppercase tracking-[0.8em]">Pro-Sollar High Performance Engineering • 2026</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCpcQqXdDWtEW2wPsj9Z2dLdt_IzLLKWV8",
            authDomain: "pro-sollar-performance.firebaseapp.com",
            projectId: "pro-sollar-performance",
            storageBucket: "pro-sollar-performance.firebasestorage.app",
            messagingSenderId: "484051034820",
            appId: "1:484051034820:web:3cf21ee3ce55b9c5625f91"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage(); 
        
        let currentLeadId = null;
        let leadData = null;
        let wealthChart = null;
        
        // STATES
        let currentChartMode = 'cash';
        let currentTimeRange = 25;
        let currentInterestRate = 1.50;
        let currentLoanTerm = 60;
        let isNegotiating = false; 
        let selectedFile = null;

        // AUTH & LOAD
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('user-email-display').innerText = user.email;
                const params = new URLSearchParams(window.location.search);
                const urlId = params.get('id');
                if(urlId) { currentLeadId = urlId; await carregarPainel(urlId, user.email); }
                else { await buscarPorEmail(user.email); }
            } else { window.location.href = "login.html"; }
        });

        async function buscarPorEmail(email) {
            const snapshot = await db.collection("leads").where("perfil.email", "==", email).limit(1).get();
            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                currentLeadId = doc.id;
                await carregarPainel(doc.id, email);
            } else {
                const oldSnap = await db.collection("leads").where("email", "==", email).limit(1).get();
                if(!oldSnap.empty) {
                    const doc = oldSnap.docs[0];
                    currentLeadId = doc.id;
                    await carregarPainel(doc.id, email);
                } else { alert("Proposta não encontrada."); window.location.href="index.html"; }
            }
        }

        async function carregarPainel(id, userEmail) {
            try {
                const docRef = db.collection("leads").doc(id);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    leadData = docSnap.data();
                    const emailDono = leadData.perfil?.email || leadData.email;
                    if(emailDono !== userEmail) { alert("Acesso negado."); window.location.href="index.html"; return; }
                    renderizarDados(leadData);
                }
            } catch(e) { console.error(e); }
        }

        function renderizarDados(data) {
            const endereco = data.perfil?.endereco_completo || data.endereco;
            document.getElementById('display-address').innerText = endereco;
            const qtdPaineis = data.engenharia?.projetado?.qtd_modulos || 0;
            const kwp = data.engenharia?.projetado?.potencia_instalada_kwp || 0;
            document.getElementById('display-specs').innerText = `${endereco.split(',')[1] || ""} • ${kwp} kWp • ${qtdPaineis} Painéis`;

            const aplicouDesconto = data.status?.desconto_aplicado || false;
            const precoBruto = data.financeiro?.investimento_bruto || 0;
            const precoLiq = data.financeiro?.valor_final || 0;
            
            if(aplicouDesconto) applyDiscountUI(precoLiq);
            else removeDiscountUI(precoBruto);

            const kpiGen = data.engenharia?.projetado?.geracao_mensal_media_inicial || 0;
            let economiaAno1 = 0;
            if (data.financeiro?.fluxo_caixa_mensal) {
                economiaAno1 = data.financeiro.fluxo_caixa_mensal.slice(0, 12).reduce((a, b) => a + b.receita_economia, 0);
            }
            document.getElementById('kpi-generation').innerText = kpiGen + " kWh";
            document.getElementById('kpi-economy').innerText = economiaAno1.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0});
            document.getElementById('kpi-payback').innerText = (data.financeiro?.payback_anos || 0) + " Anos";
            document.getElementById('kpi-roi').innerText = (data.financeiro?.economia_total_acumulada || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0});

            if (data.status?.fase === "em_analise_concorrencia") {
                showAnaliseEnviadaUI();
            }

            document.getElementById('loading-skeleton').classList.add('hidden');
            document.getElementById('content-panel').classList.remove('hidden');
            updateChart();
        }

        // --- SISTEMA DE GRÁFICOS ---
        window.updateInterestRate = function(val) { currentInterestRate = parseFloat(val); document.getElementById('rate-display').innerText = currentInterestRate.toFixed(2) + "%"; updateChart(); }
        window.updateLoanTerm = function(val) { currentLoanTerm = parseInt(val); document.getElementById('term-display').innerText = currentLoanTerm + "x"; updateChart(); }

        window.switchChartMode = function(mode) {
            currentChartMode = mode;
            document.getElementById('mode-cash').className = mode === 'cash' ? 'toggle-btn active-green' : 'toggle-btn';
            document.getElementById('mode-finan').className = mode === 'finan' ? 'toggle-btn active' : 'toggle-btn';
            
            const desc = document.getElementById('chart-desc');
            const btn1Year = document.getElementById('time-1');
            const finanControls = document.getElementById('finan-controls');

            // Lógica de Visibilidade dos Controles
            if(mode === 'cash') {
                desc.innerText = "Comparativo de Acúmulo de Patrimônio vs CDI (Renda Fixa)";
                btn1Year.classList.add('hidden-important'); 
                finanControls.classList.add('hidden'); // ESCONDE OS SLIDERS
                
                if(currentTimeRange === 1) window.switchTimeRange(25);

            } else {
                desc.innerText = "Simulador de Financiamento: Economia vs Parcela";
                btn1Year.classList.remove('hidden-important');
                finanControls.classList.remove('hidden'); // MOSTRA OS SLIDERS
            }
            updateChart();
        }

        window.switchTimeRange = function(range) {
            currentTimeRange = range;
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`time-${range}`).classList.add('active');
            updateChart();
        }

        function updateChart() {
            if(!leadData) return;
            const fluxo = leadData.financeiro.fluxo_caixa_mensal;
            const precoString = document.getElementById('display-price').innerText;
            const investimentoAtual = parseFloat(precoString.replace(/[R$\s.]/g, '').replace(',', '.'));
            const ctx = document.getElementById('wealthChart').getContext('2d');

            if (currentChartMode === 'cash') {
                const labels = ["Início"];
                const dataSolar = [-investimentoAtual];
                const dataCDI = [0]; 
                const taxaCdiLiq = 0.095; 
                const dadosAnuais = fluxo.filter(m => (m.mes % 12 === 0) && (m.ano <= currentTimeRange));
                
                dadosAnuais.forEach(d => {
                    labels.push("Ano " + d.ano);
                    dataSolar.push(d.fluxo_acumulado); 
                    const montanteCdi = investimentoAtual * Math.pow((1+taxaCdiLiq), d.ano);
                    dataCDI.push(montanteCdi - investimentoAtual);
                });

                let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(34, 197, 94, 0.5)'); gradient.addColorStop(1, 'rgba(34, 197, 94, 0.0)');

                if (wealthChart) wealthChart.destroy();
                wealthChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [
                        { label: 'Patrimônio Solar', data: dataSolar, borderColor: '#22c55e', backgroundColor: gradient, borderWidth: 3, pointBackgroundColor: '#fff', fill: true, tension: 0.3 },
                        { label: 'Rendimentos CDI', data: dataCDI, borderColor: '#64748b', borderWidth: 2, borderDash: [5,5], pointRadius: 0, fill: false, tension: 0.3 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, labels: {color:'#94a3b8'} } }, scales: { y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: { color:'#64748b', callback: v => 'R$ ' + v/1000 + 'k' } }, x: { grid: {display:false}, ticks: { color:'#64748b' } } } }
                });
            } else {
                const prazo = currentLoanTerm;
                const carencia = 2; 
                const taxaAm = currentInterestRate / 100; 
                const parcela = (investimentoAtual * taxaAm * Math.pow(1+taxaAm, prazo)) / (Math.pow(1+taxaAm, prazo) - 1);
                const labels = [];
                const dataEconomia = [];
                const dataParcela = [];
                const mesesVisualizacao = currentTimeRange * 12; 

                for(let i=1; i <= mesesVisualizacao; i++) {
                    labels.push(i);
                    const dadoMes = fluxo[i-1];
                    const economia = dadoMes ? dadoMes.receita_economia : 0; 
                    dataEconomia.push(economia);
                    if (i <= carencia) { dataParcela.push(0); } else if (i <= (prazo + carencia)) { dataParcela.push(parcela); } else { dataParcela.push(0); }
                }

                let gradientBlue = ctx.createLinearGradient(0, 0, 0, 300);
                gradientBlue.addColorStop(0, 'rgba(59, 130, 246, 0.4)'); gradientBlue.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                if (wealthChart) wealthChart.destroy();
                wealthChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [
                        { label: 'Economia Mensal (R$)', data: dataEconomia, borderColor: '#22c55e', borderWidth: 3, pointRadius: 0, tension: 0.4, fill: false, order: 1 },
                        { label: `Parcela Fixa (${prazo}x)`, data: dataParcela, borderColor: '#3b82f6', backgroundColor: gradientBlue, borderWidth: 2, pointRadius: 0, tension: 0.1, fill: true, order: 2, stepped: 'middle' }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, labels: {color:'#94a3b8'} }, tooltip: { callbacks: { label: c => c.dataset.label + ": " + c.parsed.y.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) } } }, scales: { y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: { color:'#64748b' }, title: { display: true, text: 'Valor (R$)', color: '#475569' } }, x: { grid: {display:false}, ticks: { color:'#64748b', maxTicksLimit: 12 }, title: { display: true, text: 'Meses', color: '#475569' } } } }
                });
            }
        }

        // --- SISTEMA DE NEGOCIAÇÃO E UPLOAD ---
        
        window.toggleUpload = function() {
            const uploadBox = document.getElementById('comp-upload');
            const btnFinal = document.getElementById('btn-final-action');
            const btnChallenge = document.getElementById('btn-challenge');
            const statusTitle = document.getElementById('status-title');
            const statusIcon = document.getElementById('status-icon');
            const btnDiscount = document.getElementById('btn-discount');

            // 1. Lógica de Exclusividade: Se Desconto estiver ativo, desliga ele.
            if (btnDiscount.classList.contains('active')) {
                window.toggleDiscount(); 
            }

            uploadBox.classList.toggle('hidden');
            
            if (!uploadBox.classList.contains('hidden')) {
                // MODO NEGOCIAÇÃO ATIVO
                isNegotiating = true;
                btnChallenge.classList.add('active'); 
                btnFinal.className = "btn-negotiate-action w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4";
                btnFinal.innerHTML = 'Solicitar Avaliação Comparativa <i class="fas fa-file-signature text-sm"></i>';
                statusTitle.innerText = "Análise de Concorrência";
                statusIcon.className = "fas fa-search-dollar text-blue-500 text-xl";
                btnFinal.onclick = enviarAnaliseComparativa;
            } else {
                // VOLTA AO MODO PADRÃO
                isNegotiating = false;
                btnChallenge.classList.remove('active');
                btnFinal.className = "btn-approve w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4";
                btnFinal.innerHTML = 'Aprovar e Agendar Visita <i class="fas fa-calendar-check text-sm"></i>';
                statusTitle.innerText = "Tudo pronto para economizar?";
                statusIcon.className = "fas fa-file-contract text-blue-500 text-xl";
                btnFinal.onclick = () => alert("Redirecionando para contrato...");
            }
        }

        window.handleFileSelect = function(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                document.getElementById('upload-text').innerText = "Arquivo selecionado: " + selectedFile.name;
                document.getElementById('upload-text').classList.add('text-green-400');
                document.getElementById('upload-icon').className = "fas fa-file-pdf text-4xl text-green-500 mb-4";
            }
        }

        async function enviarAnaliseComparativa() {
            if (!selectedFile) {
                alert("Por favor, selecione o arquivo PDF da proposta concorrente antes de enviar.");
                return;
            }
            const btn = document.getElementById('btn-final-action');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`competitors/${currentLeadId}/${selectedFile.name}`);
                await fileRef.put(selectedFile);
                const fileUrl = await fileRef.getDownloadURL();

                await db.collection("leads").doc(currentLeadId).update({
                    "status.fase": "em_analise_concorrencia",
                    "status.data_solicitacao_analise": firebase.firestore.FieldValue.serverTimestamp(),
                    "concorrencia": { arquivo_url: fileUrl, nome_arquivo: selectedFile.name }
                });
                showAnaliseEnviadaUI();
            } catch (error) {
                console.error("Erro upload:", error);
                alert("Erro ao enviar arquivo.");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function showAnaliseEnviadaUI() {
            document.getElementById('comp-upload').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-white">Solicitação Enviada!</h3>
                    <p class="text-sm text-slate-400 mt-2">Nossa engenharia está analisando o documento.</p>
                    <p class="text-xs text-slate-500 mt-1">Retornaremos em breve pelo WhatsApp.</p>
                </div>
            `;
            document.getElementById('comp-upload').classList.remove('hidden', 'upload-area');
            document.getElementById('comp-upload').onclick = null; 
            document.getElementById('btn-final-action').style.display = 'none';
            document.getElementById('btn-challenge').style.display = 'none';
            document.getElementById('btn-discount').style.display = 'none';
        }

        // --- GLOBAL ACTIONS ---
        window.toggleDiscount = async function() {
            if (!currentLeadId || !leadData) return;
            const btn = document.getElementById('btn-discount');
            const isActive = btn.classList.contains('active');
            const bruto = leadData.financeiro.investimento_bruto;
            const liquido = leadData.financeiro.valor_final;

            // 2. Lógica de Exclusividade: Se Negociação estiver ativa, fecha ela.
            if (isNegotiating) {
                window.toggleUpload(); // Reseta o modo negociação
            }

            if (!isActive) {
                applyDiscountUI(liquido);
                await db.collection("leads").doc(currentLeadId).update({ "status.desconto_aplicado": true });
            } else {
                removeDiscountUI(bruto);
                await db.collection("leads").doc(currentLeadId).update({ "status.desconto_aplicado": false });
            }
        }

        function applyDiscountUI(val) {
            document.getElementById('display-price').innerText = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('display-price').classList.add('text-green-500');
            document.getElementById('footer-text').innerText = "Condição à Vista Aplicada";
            document.getElementById('footer-text').classList.add('text-green-500');
            document.getElementById('savings-badge').classList.remove('hidden');
            const btn = document.getElementById('btn-discount');
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-check mr-2 text-green-500"></i> Desconto Ativado';
            updateChart();
        }

        function removeDiscountUI(val) {
            document.getElementById('display-price').innerText = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('display-price').classList.remove('text-green-500');
            document.getElementById('footer-text').innerText = "Condição padrão selecionada";
            document.getElementById('footer-text').classList.remove('text-green-500');
            document.getElementById('savings-badge').classList.add('hidden');
            const btn = document.getElementById('btn-discount');
            btn.classList.remove('active');
            btn.innerHTML = '<i class="fas fa-tag mr-2 text-yellow-500"></i> Desconto à Vista';
            updateChart();
        }

        window.toggleUpload = toggleUpload; 
        window.logout = () => auth.signOut().then(() => window.location.href = "index.html");
        // COMO DEVE FICAR (CONECTADO AO CHECKOUT):
        document.getElementById('btn-final-action').onclick = () => {
            // Verifica se temos o ID do cliente
            if (currentLeadId) {
                // Leva para o checkout enviando o ID na URL
                window.location.href = `checkout.html?id=${currentLeadId}`;
            } else {
                // Segurança caso a página tenha perdido a conexão
                alert("Erro de identificação. Por favor, recarregue a página.");
                window.location.reload();
            }
        };
    </script>
