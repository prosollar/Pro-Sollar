<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Sollar | Portal da Independência Energética</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');

        :root {
            --bg-deep: #0a1120;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #facc15;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(34, 197, 94, 0.05) 0%, transparent 30%);
            background-attachment: fixed;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .step-container { position: relative; }
        .step-line {
            position: absolute;
            left: 15px; top: 32px; bottom: -20px; width: 1px;
            background: rgba(255, 255, 255, 0.05);
        }
        .step-active .step-line {
            background: linear-gradient(to bottom, var(--accent-blue), rgba(59, 130, 246, 0.1));
        }

        .step-number {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 900; position: relative; z-index: 10;
        }

        .btn-approve {
            background: var(--accent-green);
            color: #052e16;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2);
            transition: all 0.3s ease;
        }

        .btn-approve:hover {
            transform: scale(1.02) translateY(-2px);
            box-shadow: 0 15px 40px rgba(34, 197, 94, 0.4);
            background: #4ade80;
        }

        .negotiation-btn {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .negotiation-btn:hover {
            border-color: var(--accent-yellow);
            background: rgba(250, 204, 21, 0.05);
        }
        .negotiation-btn.active {
            border-color: var(--accent-green);
            background: rgba(34, 197, 94, 0.08);
        }
        
        /* Chart Container Styling */
        .chart-container {
            position: relative; 
            height: 300px; 
            width: 100%;
        }
    </style>
</head>
<body class="p-4 md:p-10 lg:p-16">

    <div class="max-w-6xl mx-auto">
        
        <header class="flex justify-between items-center mb-12">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl flex items-center justify-center shadow-2xl">
                    <i class="fas fa-solar-panel text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter italic leading-none">Pro-<span class="text-blue-500">Sollar</span></h1>
                </div>
            </div>
            <div class="glass-card px-5 py-2 flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Conectado como</p>
                    <p id="user-email-display" class="text-xs font-bold text-blue-400">...</p>
                </div>
                <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="loading-skeleton" class="animate-pulse glass-card p-12 mb-8 text-center">
            <i class="fas fa-satellite-dish fa-spin text-4xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-bold">Processando dados de engenharia...</h2>
            <p class="text-sm text-slate-400">Calculando fluxo de caixa e viabilidade.</p>
        </div>

        <div id="content-panel" class="hidden animate-in fade-in duration-700">
            
            <div class="glass-card p-8 md:p-10 border-blue-500/20 bg-blue-500/[0.02] mb-8">
                <div class="flex flex-wrap justify-between items-start gap-6">
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-[10px] font-black uppercase tracking-[0.3em] text-green-500">Projeto Viável</span>
                        </div>
                        <h3 id="display-address" class="text-2xl md:text-4xl font-black italic text-white mb-2">...</h3>
                        <p id="display-specs" class="text-sm text-slate-400 font-bold uppercase tracking-widest">...</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest mb-1">Aporte Inicial</p>
                        <p id="display-price" class="text-3xl md:text-4xl font-black text-white italic">R$ --.--</p>
                        <p id="savings-badge" class="hidden text-[10px] text-green-500 font-bold uppercase tracking-widest mt-1">Desconto aplicado</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card p-6 text-center border-green-500/10 hover:bg-green-500/5 transition-all">
                    <i class="fas fa-bolt text-yellow-400 text-xl mb-2"></i>
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Geração Mês</p>
                    <p id="kpi-generation" class="text-xl font-bold text-white">-- kWh</p>
                </div>
                <div class="glass-card p-6 text-center border-blue-500/10 hover:bg-blue-500/5 transition-all">
                    <i class="fas fa-wallet text-blue-400 text-xl mb-2"></i>
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Economia Ano 1</p>
                    <p id="kpi-economy" class="text-xl font-bold text-white">R$ --</p>
                </div>
                <div class="glass-card p-6 text-center border-purple-500/10 hover:bg-purple-500/5 transition-all">
                    <i class="fas fa-hourglass-half text-purple-400 text-xl mb-2"></i>
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Payback</p>
                    <p id="kpi-payback" class="text-xl font-bold text-white">-- Anos</p>
                </div>
                <div class="glass-card p-6 text-center border-green-500/20 bg-green-500/5 transform hover:scale-105 transition-all">
                    <i class="fas fa-piggy-bank text-green-400 text-xl mb-2"></i>
                    <p class="text-[10px] text-green-300 font-black uppercase tracking-widest">Lucro 25 Anos</p>
                    <p id="kpi-roi" class="text-xl font-black text-green-400">R$ --</p>
                </div>
            </div>

            <div class="glass-card p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-chart-line text-blue-500 mr-2"></i> Evolução Patrimonial</h3>
                    <span class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Projeção 25 Anos</span>
                </div>
                <div class="chart-container">
                    <canvas id="wealthChart"></canvas>
                </div>
                <p class="text-[10px] text-center text-slate-500 mt-4 italic">
                    *Considera inflação energética de 10% a.a. e custos de manutenção/reposição.
                </p>
            </div>

            <div class="pt-8 border-t border-white/5">
                <div class="flex flex-wrap gap-4 mb-8">
                    <button id="btn-discount" onclick="toggleDiscount()" class="negotiation-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all w-full sm:w-auto">
                        <i class="fas fa-tag mr-2 text-yellow-500"></i> Desconto à Vista
                    </button>
                    <button onclick="toggleUpload()" class="negotiation-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest w-full sm:w-auto">
                        <i class="fas fa-handshake mr-2 text-blue-500"></i> Cobrir Concorrente
                    </button>
                </div>

                <div id="comp-upload" class="hidden animate-in fade-in duration-500 mb-8 p-8 rounded-3xl bg-yellow-500/5 border border-yellow-500/10">
                    <div class="text-center">
                        <i class="fas fa-file-pdf text-3xl text-slate-700 mb-4"></i>
                        <p class="text-xs font-bold text-white mb-2">Anexe a proposta concorrente</p>
                        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Cobriremos o valor tecnicamente.</p>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row items-center justify-between gap-8 mt-10">
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 glass-card rounded-2xl flex items-center justify-center border-blue-500/20">
                            <i class="fas fa-file-contract text-blue-500 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white italic">Confirmar projeto agora?</p>
                            <p id="footer-text" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1 italic">Condição padrão selecionada</p>
                        </div>
                    </div>
                    
                    <button id="btn-final-action" class="btn-approve w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4">
                        Aprovar e Agendar Visita <i class="fas fa-calendar-check text-sm"></i>
                    </button>
                </div>
            </div>

        </div>

        <footer class="text-center py-10 opacity-30 border-t border-white/5 mt-12">
            <p class="text-[9px] font-black uppercase tracking-[0.8em]">Pro-Sollar High Performance Engineering • 2026</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCpcQqXdDWtEW2wPsj9Z2dLdt_IzLLKWV8",
            authDomain: "pro-sollar-performance.firebaseapp.com",
            projectId: "pro-sollar-performance",
            storageBucket: "pro-sollar-performance.firebasestorage.app",
            messagingSenderId: "484051034820",
            appId: "1:484051034820:web:3cf21ee3ce55b9c5625f91"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentLeadId = null;
        let leadData = null;
        let wealthChart = null; // Instância do gráfico

        // AUTH CHECK
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('user-email-display').innerText = user.email;
                const params = new URLSearchParams(window.location.search);
                const urlId = params.get('id');

                if(urlId) {
                    currentLeadId = urlId;
                    await carregarPainel(urlId, user.email);
                } else {
                    await buscarPorEmail(user.email);
                }
            } else {
                window.location.href = "login.html";
            }
        });

        async function buscarPorEmail(email) {
            const snapshot = await db.collection("leads").where("perfil.email", "==", email).limit(1).get();
            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                currentLeadId = doc.id;
                await carregarPainel(doc.id, email);
            } else {
                // Fallback para schema antigo
                const oldSnap = await db.collection("leads").where("email", "==", email).limit(1).get();
                if(!oldSnap.empty) {
                    const doc = oldSnap.docs[0];
                    currentLeadId = doc.id;
                    await carregarPainel(doc.id, email);
                } else {
                    alert("Proposta não encontrada.");
                    window.location.href = "index.html";
                }
            }
        }

        async function carregarPainel(id, userEmail) {
            try {
                const docRef = db.collection("leads").doc(id);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    leadData = docSnap.data();
                    // Validação simples
                    const emailDono = leadData.perfil?.email || leadData.email;
                    if(emailDono !== userEmail) {
                        alert("Acesso não autorizado."); window.location.href="index.html"; return;
                    }
                    renderizarDados(leadData);
                }
            } catch(e) { console.error(e); }
        }

        function renderizarDados(data) {
            // 1. HEADER & HERO
            const endereco = data.perfil?.endereco_completo || data.endereco;
            const cidade = endereco.split(',')[1] || "";
            document.getElementById('display-address').innerText = endereco;
            
            // Dados de Engenharia
            const qtdPaineis = data.engenharia?.projetado?.qtd_modulos || 0;
            const kwp = data.engenharia?.projetado?.potencia_instalada_kwp || 0;
            const area = data.engenharia?.projetado?.area_ocupada_m2 || 0;
            
            document.getElementById('display-specs').innerText = 
                `${cidade} • ${kwp} kWp • ${qtdPaineis} Painéis (${area}m²)`;

            // 2. FINANCEIRO & PREÇO
            const aplicouDesconto = data.status?.desconto_aplicado || false;
            const precoBruto = data.financeiro?.investimento_bruto || 0;
            const precoLiq = data.financeiro?.valor_final || 0;

            if(aplicouDesconto) applyDiscountUI(precoLiq);
            else removeDiscountUI(precoBruto);

            // 3. KPIs (DADOS DO ARRAY FINANCEIRO)
            const kpiGen = data.engenharia?.projetado?.totais?.media_mensal_kwh || 0;
            const kpiEco = data.financeiro?.economia_estimada_mensal || (kpiGen * 0.92); // Fallback
            const kpiPayback = data.financeiro?.payback_anos || 0;
            const kpiLucro = data.financeiro?.economia_total_acumulada || 0;

            document.getElementById('kpi-generation').innerText = kpiGen + " kWh";
            document.getElementById('kpi-economy').innerText = "R$ " + (kpiEco * 12).toLocaleString('pt-BR', {maximumFractionDigits:0});
            document.getElementById('kpi-payback').innerText = kpiPayback + " Anos";
            document.getElementById('kpi-roi').innerText = kpiLucro.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL', maximumFractionDigits: 0});

            // 4. CHART.JS (FLUXO DE CAIXA)
            renderizarGrafico(data.financeiro?.fluxo_caixa_mensal || []);

            // SHOW
            document.getElementById('loading-skeleton').classList.add('hidden');
            document.getElementById('content-panel').classList.remove('hidden');
        }

        function renderizarGrafico(fluxoMensal) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            
            // Filtra para pegar apenas 1 ponto por ano (Mês 12, 24, 36...) para não poluir
            const dadosAnuais = fluxoMensal.filter(m => m.mes % 12 === 0);
            
            const labels = dadosAnuais.map(d => "Ano " + d.ano);
            const dataPoints = dadosAnuais.map(d => d.fluxo_acumulado);

            // Gradiente Verde
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(34, 197, 94, 0.5)'); // Verde forte
            gradient.addColorStop(1, 'rgba(34, 197, 94, 0.0)'); // Transparente

            if (wealthChart) wealthChart.destroy(); // Limpa anterior se houver

            wealthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Saldo Acumulado (R$)',
                        data: dataPoints,
                        borderColor: '#22c55e', // accent-green
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointRadius: 3,
                        fill: true,
                        tension: 0.4 // Curva suave
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#64748b', callback: (val) => 'R$ ' + val/1000 + 'k' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', maxTicksLimit: 8 }
                        }
                    }
                }
            });
        }

        // --- LÓGICA DE UI (BOTOES) ---
        window.toggleDiscount = async function() {
            if (!currentLeadId || !leadData) return;
            const btn = document.getElementById('btn-discount');
            const isActive = btn.classList.contains('active');
            
            const bruto = leadData.financeiro.investimento_bruto;
            const liquido = leadData.financeiro.valor_final;

            if (!isActive) {
                applyDiscountUI(liquido);
                await db.collection("leads").doc(currentLeadId).update({ "status.desconto_aplicado": true });
            } else {
                removeDiscountUI(bruto);
                await db.collection("leads").doc(currentLeadId).update({ "status.desconto_aplicado": false });
            }
        }

        function applyDiscountUI(val) {
            document.getElementById('display-price').innerText = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('display-price').classList.add('text-green-500');
            document.getElementById('footer-text').innerText = "Condição à Vista Aplicada";
            document.getElementById('footer-text').classList.add('text-green-500');
            document.getElementById('savings-badge').classList.remove('hidden');
            const btn = document.getElementById('btn-discount');
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-check mr-2 text-green-500"></i> Desconto Ativado';
        }

        function removeDiscountUI(val) {
            document.getElementById('display-price').innerText = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('display-price').classList.remove('text-green-500');
            document.getElementById('footer-text').innerText = "Condição padrão selecionada";
            document.getElementById('footer-text').classList.remove('text-green-500');
            document.getElementById('savings-badge').classList.add('hidden');
            const btn = document.getElementById('btn-discount');
            btn.classList.remove('active');
            btn.innerHTML = '<i class="fas fa-tag mr-2 text-yellow-500"></i> Desconto à Vista';
        }

        window.toggleUpload = () => document.getElementById('comp-upload').classList.toggle('hidden');
        window.logout = () => auth.signOut().then(() => window.location.href = "index.html");
        
        document.getElementById('btn-final-action').onclick = () => {
             // Futuro: window.location.href = `checkout.html?id=${currentLeadId}`;
             alert("Redirecionando para contrato...");
        };
    </script>
</body>
</html>
