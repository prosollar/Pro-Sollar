<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Sollar | Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap');
        
        :root { --bg-deep: #0a1120; --accent-blue: #3b82f6; --accent-green: #22c55e; --accent-yellow: #facc15; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-deep); color: white; min-height: 100vh; background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), radial-gradient(circle at 0% 100%, rgba(34, 197, 94, 0.05) 0%, transparent 30%); background-attachment: fixed; }
        
        /* CLASSES VISUAIS */
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 2rem; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-approve { background: var(--accent-green); color: #052e16; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2); transition: all 0.3s ease; cursor: pointer; }
        .btn-approve:hover { transform: scale(1.02) translateY(-2px); box-shadow: 0 15px 40px rgba(34, 197, 94, 0.4); background: #4ade80; }
        .btn-negotiate-action { background: var(--accent-blue); color: white; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; cursor: pointer; }
        .btn-negotiate-action:hover { transform: scale(1.02) translateY(-2px); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.5); background: #60a5fa; }
        .negotiation-btn { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .negotiation-btn:hover { border-color: var(--accent-yellow); background: rgba(250, 204, 21, 0.05); }
        .negotiation-btn.active { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.08); }
        
        .chart-container { position: relative; height: 320px; width: 100%; }
        .chart-toggle { background: rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 4px; display: inline-flex; margin-bottom: 20px; }
        .toggle-btn { padding: 8px 20px; border-radius: 0.8rem; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; color: #64748b; cursor: pointer; }
        .toggle-btn.active { background: var(--accent-blue); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .toggle-btn.active-green { background: var(--accent-green); color: #064e3b; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }
        
        .time-selector { display: flex; justify-content: center; gap: 8px; margin-top: 15px; }
        .time-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 6px 16px; border-radius: 20px; font-size: 10px; font-weight: 700; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .time-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .time-btn.active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; box-shadow: 0 0 10px rgba(255,255,255,0.05); }
        .hidden-important { display: none !important; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 2px; }
        
        .control-group label { font-size: 10px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.1em; color: #93c5fd; }
        .control-value { font-size: 14px; font-weight: 900; color: white; }
        .upload-area { cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { background: rgba(250, 204, 21, 0.1); border-color: var(--accent-yellow); }

        /* ESTILO DO MODAL E INPUTS */
        .modal-bg { background: rgba(10, 17, 32, 0.8); backdrop-filter: blur(10px); }
        .input-dark { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 12px 12px 12px 45px; transition: all 0.3s; width: 100%; border-radius: 1rem; }
        .input-dark:focus { border-color: var(--accent-blue); outline: none; background: rgba(0, 0, 0, 0.6); }
        .input-wrapper { position: relative; }
        .input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
        
        .pac-container { background-color: #1e293b !important; border-radius: 1rem !important; border: 1px solid rgba(255,255,255,0.1) !important; font-family: inherit !important; z-index: 99999 !important; }
        .pac-item { color: #94a3b8 !important; padding: 12px !important; border-top: 1px solid rgba(255,255,255,0.05) !important; cursor: pointer !important; }
        .pac-item:hover { background-color: rgba(255,255,255,0.05) !important; color: white !important; }
        .pac-item-query { color: white !important; }
    </style>
</head>
<body class="p-4 md:p-10 lg:p-16">

    <div class="max-w-6xl mx-auto">
        
        <header class="flex flex-col lg:flex-row justify-between items-center mb-10 gap-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl flex items-center justify-center shadow-2xl">
                    <i class="fas fa-solar-panel text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter italic leading-none">Pro-<span class="text-blue-500">Sollar</span></h1>
                </div>
            </div>
            
            <div class="flex-1 w-full lg:w-auto flex justify-center lg:justify-end gap-3 items-center overflow-x-auto pb-2 lg:pb-0 px-2" id="project-bar">
                <div class="animate-pulse h-8 w-24 bg-white/5 rounded-full"></div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="openNewSimModal()" class="glass-card px-4 py-2 flex items-center gap-2 text-[10px] font-bold text-slate-300 hover:text-white hover:bg-white/5 transition whitespace-nowrap">
                    <i class="fas fa-plus text-yellow-500"></i> Novo
                </button>
                <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 px-2"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="loading-skeleton" class="animate-pulse glass-card p-12 mb-8 text-center">
            <i class="fas fa-satellite-dish fa-spin text-4xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-bold">Carregando seus projetos...</h2>
        </div>

        <div id="empty-state" class="hidden text-center py-20">
            <i class="fas fa-wind text-6xl text-slate-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-slate-400">Nenhuma simulação ativa</h2>
            <p class="text-sm text-slate-500 mb-6">Você limpou todos os seus rascunhos.</p>
            <button onclick="openNewSimModal()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold text-white transition">
                Criar Nova Simulação
            </button>
        </div>

        <div id="content-panel" class="hidden animate-in fade-in duration-700">
            
            <div class="glass-card p-8 md:p-10 border-blue-500/20 bg-blue-500/[0.02] mb-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <i class="fas fa-bolt text-9xl text-white"></i>
                </div>

                <div class="flex flex-wrap justify-between items-start gap-6 relative z-10">
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse" id="status-dot"></span>
                            <span class="text-[10px] font-black uppercase tracking-[0.3em] text-green-500" id="status-text">Projeto Viável</span>
                        </div>
                        <h3 id="display-address" class="text-2xl md:text-3xl font-black italic text-white mb-2 leading-tight">...</h3>
                        <p id="display-specs" class="text-xs text-slate-400 font-bold uppercase tracking-widest">...</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest mb-1">Investimento Estimado</p>
                        <p id="display-price" class="text-3xl md:text-4xl font-black text-white italic">R$ --.--</p>
                        <p id="savings-badge" class="hidden text-[10px] text-green-500 font-bold uppercase tracking-widest mt-1">Desconto aplicado</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card p-6 text-center border-white/5">
                    <i class="fas fa-bolt text-yellow-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Geração Ano 1</p>
                    <p id="kpi-generation" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="glass-card p-6 text-center border-white/5">
                    <i class="fas fa-wallet text-blue-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Economia 1º Ano</p>
                    <p id="kpi-economy" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="glass-card p-6 text-center border-white/5">
                    <i class="fas fa-hourglass-half text-purple-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Payback</p>
                    <p id="kpi-payback" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="glass-card p-6 text-center border-green-500/20 bg-green-500/5">
                    <i class="fas fa-piggy-bank text-green-400 text-lg mb-2"></i>
                    <p class="text-[9px] text-green-300 font-black uppercase tracking-widest">Lucro 25 Anos</p>
                    <p id="kpi-roi" class="text-lg font-black text-green-400">--</p>
                </div>
            </div>

            <div class="glass-card p-8 mb-8 relative overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white mb-4 md:mb-0"><i class="fas fa-chart-line text-blue-500 mr-2"></i> Análise Financeira</h3>
                    <div class="chart-toggle">
                        <div id="mode-cash" onclick="window.switchChartMode('cash')" class="toggle-btn active-green">Patrimônio</div>
                        <div id="mode-finan" onclick="window.switchChartMode('finan')" class="toggle-btn">Fluxo Mensal</div>
                    </div>
                </div>

                <div id="finan-controls" class="hidden mb-6 bg-blue-500/10 border border-blue-500/20 p-5 rounded-xl space-y-4">
                    <div class="control-group">
                        <div class="flex justify-between items-center mb-2">
                            <label><i class="fas fa-percentage mr-2"></i>Taxa de Juros (a.m.)</label>
                            <span id="rate-display" class="control-value">1.50%</span>
                        </div>
                        <input type="range" id="rate-slider" min="0.50" max="3.50" step="0.01" value="1.50" oninput="window.updateInterestRate(this.value)">
                    </div>
                    <div class="control-group border-t border-blue-500/20 pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <label><i class="fas fa-calendar-alt mr-2"></i>Prazo de Pagamento</label>
                            <span id="term-display" class="control-value">60x</span>
                        </div>
                        <input type="range" id="term-slider" min="12" max="84" step="12" value="60" oninput="window.updateLoanTerm(this.value)">
                    </div>
                </div>

                <p id="chart-desc" class="text-center text-xs text-slate-400 mb-6 font-medium">Comparativo de Acúmulo de Patrimônio vs CDI (Renda Fixa)</p>
                <div class="chart-container"><canvas id="wealthChart"></canvas></div>
                <div class="time-selector">
                    <div id="time-1" onclick="window.switchTimeRange(1)" class="time-btn hidden-important">1 ANO</div>
                    <div id="time-5" onclick="window.switchTimeRange(5)" class="time-btn">5 ANOS</div>
                    <div id="time-15" onclick="window.switchTimeRange(15)" class="time-btn">15 ANOS</div>
                    <div id="time-25" onclick="window.switchTimeRange(25)" class="time-btn active">25 ANOS</div>
                </div>
            </div>

            <div id="action-section" class="pt-8 border-t border-white/5">
                <div class="flex flex-wrap gap-4 mb-8">
                    <button id="btn-discount" onclick="window.toggleDiscount()" class="negotiation-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all w-full sm:w-auto">
                        <i class="fas fa-tag mr-2 text-yellow-500"></i> Desconto à Vista
                    </button>
                    <button id="btn-challenge" onclick="window.toggleUpload()" class="negotiation-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest w-full sm:w-auto">
                        <i class="fas fa-handshake mr-2 text-blue-500"></i> Cobrir Concorrente
                    </button>
                </div>

                <div id="comp-upload" class="hidden animate-in fade-in duration-500 mb-8 p-8 rounded-3xl bg-yellow-500/5 border border-yellow-500/10 upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="text-center">
                        <i id="upload-icon" class="fas fa-cloud-upload-alt text-4xl text-yellow-500 mb-4"></i>
                        <p id="upload-text" class="text-sm font-bold text-white mb-2">Clique para anexar a proposta (PDF)</p>
                        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Nossa engenharia fará a equiparação técnica.</p>
                        <input type="file" id="file-input" accept="application/pdf" class="hidden" onchange="window.handleFileSelect(this)">
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row items-center justify-between gap-8 mt-10">
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 glass-card rounded-2xl flex items-center justify-center border-blue-500/20">
                            <i id="status-icon" class="fas fa-file-contract text-blue-500 text-xl"></i>
                        </div>
                        <div>
                            <p id="status-title" class="text-sm font-bold text-white italic">Tudo pronto para economizar?</p>
                            <p id="footer-text" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1 italic">Condição padrão selecionada</p>
                        </div>
                    </div>
                    <button id="btn-final-action" class="btn-approve w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4">
                        Aprovar e Agendar Visita <i class="fas fa-calendar-check text-sm"></i>
                    </button>
                </div>
            </div>

            <div id="status-locked-card" class="hidden pt-8 border-t border-white/5 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <div class="glass-card p-10 border border-green-500/30 bg-green-500/5 text-center">
                    <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_40px_rgba(34,197,94,0.3)]">
                        <i class="fas fa-calendar-check text-4xl text-green-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Visita Agendada!</h2>
                    <p class="text-slate-300 text-sm mb-6 max-w-lg mx-auto">Sua reserva de preço e agendamento técnico foram confirmados.</p>
                    <div class="inline-flex items-center gap-2 bg-green-500/10 px-4 py-2 rounded-lg border border-green-500/20">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs font-bold text-green-400 uppercase tracking-widest">Processo em Andamento</span>
                    </div>
                </div>
            </div>

        </div>

        <footer class="text-center py-10 opacity-30 border-t border-white/5 mt-12">
            <p class="text-[9px] font-black uppercase tracking-[0.8em]">Pro-Sollar High Performance Engineering • 2026</p>
        </footer>
    </div>

    <div id="new-sim-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg px-4 animate-in fade-in zoom-in duration-300">
        <div class="glass-card p-8 w-full max-w-md border border-yellow-500/20 relative">
            <button onclick="closeNewSimModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-3 text-yellow-400"><i class="fas fa-plus text-xl"></i></div>
                <h3 class="text-xl font-bold text-white">Nova Simulação</h3>
                <p class="text-xs text-slate-400 mt-1">Adicione outro imóvel ao seu perfil (Máx. 3)</p>
            </div>
            <div class="space-y-4">
                <div class="input-wrapper"><input type="text" id="new-endereco" placeholder="Endereço da Instalação" class="input-dark"><i class="fas fa-map-marker-alt input-icon"></i></div>
                <div class="input-wrapper"><input type="tel" id="new-consumo" placeholder="Gasto Mensal (R$)" class="input-dark" onkeyup="window.formatarMoeda(this)"><i class="fas fa-dollar-sign input-icon"></i></div>
                <input type="hidden" id="new-lat"> <input type="hidden" id="new-lng">
                <button onclick="criarNovaSimulacao()" id="btn-create-sim" class="w-full py-4 rounded-xl font-black uppercase text-xs tracking-widest bg-gradient-to-r from-yellow-400 to-yellow-600 text-black shadow-lg hover:scale-[1.02] transition-transform">Calcular Agora</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCpcQqXdDWtEW2wPsj9Z2dLdt_IzLLKWV8",
            authDomain: "pro-sollar-performance.firebaseapp.com",
            projectId: "pro-sollar-performance",
            storageBucket: "pro-sollar-performance.firebasestorage.app",
            messagingSenderId: "484051034820",
            appId: "1:484051034820:web:3cf21ee3ce55b9c5625f91"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage(); 
        
        let currentUserEmail = null;
        let currentSimId = null;
        let leadData = null;
        let wealthChart = null;
        let userProposals = []; 
        
        let currentChartMode = 'cash';
        let currentTimeRange = 25;
        let currentInterestRate = 1.50;
        let currentLoanTerm = 60;
        let isNegotiating = false; 
        let selectedFile = null;

        // --- UTILITÁRIOS GLOBAIS ---
        window.formatarMoeda = (i) => { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2) + ''; v = v.replace(".", ","); v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); i.value = "R$ " + v; }
        window.mascaraTelefone = (i) => { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }

        // --- MOTOR DE CÁLCULO ---
        function calcularEngenhariaPrecisao(contaMensalReais, lat = -23.5) {
            const TARIFA = 0.96; const PERDA = 0.25; const PR = 1 - PERDA; const MOD = 600; 
            const HSP = 4.85; const consKwh = contaMensalReais / TARIFA;
            const potKwp = (consKwh / (HSP * 30 * PR)) * 1.10;
            const qtd = Math.ceil((potKwp * 1000) / MOD);
            const potFinal = (qtd * MOD) / 1000;
            
            let precoWp = 3.60; if(potFinal > 6) precoWp = 3.10; if(potFinal > 10) precoWp = 2.85;
            const invest = potFinal * 1000 * precoWp;
            
            let fluxo = []; let acc = 0; let tarifa = TARIFA;
            for(let i=0; i<300; i++) {
                let hspMes = HSP * [1.2,1.15,1.05,0.95,0.85,0.75,0.8,0.95,1,1.05,1.1,1.15][i%12];
                let deg = 1-(i*0.00067);
                let gen = potFinal * hspMes * 30 * PR * deg;
                let eco = gen * tarifa;
                acc += eco;
                fluxo.push({ mes_absoluto: i+1, ano: Math.ceil((i+1)/12), geracao_kwh: gen, economia_reais: eco, fluxo_acumulado: acc - invest });
                tarifa *= 1.005;
            }
            return {
                engenharia: { projetado: { potencia_instalada_kwp: potFinal.toFixed(2), qtd_modulos: qtd, geracao_mensal_media_ano1: fluxo[0].geracao_kwh, area_ocupada_m2: (qtd*2.5).toFixed(1) } },
                configuracao_sistema: { modulo: { modelo: "Módulo 600W", potencia: 600 }, inversor: { tipo: "Inversor String" } },
                financeiro: { investimento_bruto: invest, valor_final: invest, economia_total_acumulada: acc, payback_anos: 3.5, fluxo_caixa_mensal: fluxo }
            };
        }

        // --- AUTH & LOAD ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserEmail = user.email;
            } else { 
                const params = new URLSearchParams(window.location.search);
                const urlEmail = params.get('email');
                if(urlEmail) currentUserEmail = urlEmail;
                else return window.location.href = "login.html"; 
            }
            await carregarProjetosDoUsuario(currentUserEmail);
        });

        async function carregarProjetosDoUsuario(email) {
            try {
                const snapshot = await db.collection("leads").doc(email).collection("simulacoes").orderBy("data_criacao", "desc").get();
                if (snapshot.empty) { 
                    // Estado Vazio (Sem projetos)
                    document.getElementById('loading-skeleton').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('content-panel').classList.add('hidden');
                    return; 
                }

                userProposals = [];
                snapshot.forEach(doc => userProposals.push({ id: doc.id, ...doc.data() }));

                document.getElementById('empty-state').classList.add('hidden');
                renderizarBarraDeProjetos();

                const params = new URLSearchParams(window.location.search);
                const urlSimId = params.get('simId');
                const activeProject = urlSimId ? userProposals.find(p => p.id === urlSimId) : userProposals[0];
                
                if(activeProject) carregarProjetoNaTela(activeProject);

            } catch (e) { console.error("Erro:", e); }
        }

        function renderizarBarraDeProjetos() {
            const container = document.getElementById('project-bar');
            container.innerHTML = ''; 
            userProposals.forEach((proj, index) => {
                const isActive = proj.id === currentSimId;
                const isAgendada = proj.status?.fase === 'visita_agendada';
                const nome = proj.detalhes?.nome_projeto || `Projeto ${index + 1}`;
                
                const wrapper = document.createElement('div');
                wrapper.className = "relative group flex items-center";

                const btn = document.createElement('button');
                btn.className = `whitespace-nowrap px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border ${isActive ? 'bg-blue-500 border-blue-400 text-white shadow-lg shadow-blue-500/30' : 'bg-white/5 border-white/10 text-slate-400 hover:bg-white/10 hover:text-white'}`;
                
                const statusIcon = isAgendada ? '<i class="fas fa-check-circle text-green-300 ml-1"></i>' : '';
                
                let html = `<span>${nome} ${statusIcon}</span>`;
                
                if (!isAgendada) {
                    html += `<span onclick="event.stopPropagation(); deletarSimulacao('${proj.id}')" class="ml-1 w-5 h-5 flex items-center justify-center rounded-full hover:bg-red-500/20 text-slate-500 hover:text-red-500 transition cursor-pointer"><i class="fas fa-times text-[10px]"></i></span>`;
                }

                btn.innerHTML = html;
                btn.onclick = () => carregarProjetoNaTela(proj);
                
                // MUDANÇA: O botão agora é um container flex para o ícone de deletar ficar dentro visualmente
                btn.style.display = "flex";
                btn.style.alignItems = "center";
                btn.style.gap = "8px";

                wrapper.appendChild(btn);
                container.appendChild(wrapper);
            });
        }

        async function deletarSimulacao(id) {
            if(!confirm("Tem certeza que deseja remover esta simulação?")) return;
            try {
                await db.collection("leads").doc(currentUserEmail).collection("simulacoes").doc(id).delete();
                userProposals = userProposals.filter(p => p.id !== id);
                renderizarBarraDeProjetos();
                
                if (id === currentSimId) {
                    if (userProposals.length > 0) carregarProjetoNaTela(userProposals[0]);
                    else {
                        document.getElementById('content-panel').classList.add('hidden');
                        document.getElementById('empty-state').classList.remove('hidden');
                    }
                }
            } catch(e) { alert("Erro ao deletar."); console.error(e); }
        }

        function carregarProjetoNaTela(projeto) {
            currentSimId = projeto.id;
            leadData = projeto;
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + `?email=${encodeURIComponent(currentUserEmail)}&simId=${currentSimId}`;
            window.history.pushState({path:newUrl},'',newUrl);
            renderizarBarraDeProjetos(); 
            renderizarDados(projeto);
        }

        // --- LÓGICA DO MODAL DE NOVA SIMULAÇÃO ---
        window.openNewSimModal = function() { document.getElementById('new-sim-modal').classList.remove('hidden'); }
        window.closeNewSimModal = function() { document.getElementById('new-sim-modal').classList.add('hidden'); }

        window.criarNovaSimulacao = async function() {
            const btn = document.getElementById('btn-create-sim');
            const originalText = btn.innerText;
            const endereco = document.getElementById('new-endereco').value;
            const consumoRaw = document.getElementById('new-consumo').value;
            const lat = document.getElementById('new-lat').value || "-23.55";

            if(!endereco || !consumoRaw) { alert("Preencha todos os campos."); return; }
            if(userProposals.length >= 3) { alert("Limite de 3 simulações atingido."); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Calculando...';

            try {
                const consumoLimpo = parseFloat(consumoRaw.replace(/[^0-9,]/g, '').replace(',', '.'));
                const dados = calcularEngenhariaPrecisao(consumoLimpo, parseFloat(lat));
                const nomeProjeto = endereco.split(',')[0].substring(0, 20);
                
                const zapAtual = leadData?.perfil?.whatsapp_formatted || "";

                const novoProjeto = {
                    engenharia: dados.engenharia,
                    configuracao_sistema: dados.configuracao_sistema,
                    financeiro: dados.financeiro,
                    perfil: { whatsapp_formatted: zapAtual }, 
                    detalhes: { endereco_completo: endereco, nome_projeto: nomeProjeto, consumo_simulado: consumoLimpo },
                    data_criacao: firebase.firestore.FieldValue.serverTimestamp(),
                    status: { fase: 'nova_simulacao', desconto_aplicado: false }
                };

                const docRef = await db.collection("leads").doc(currentUserEmail).collection("simulacoes").add(novoProjeto);
                const projetoSalvo = { id: docRef.id, ...novoProjeto };
                
                userProposals.unshift(projetoSalvo); 
                closeNewSimModal();
                document.getElementById('empty-state').classList.add('hidden'); 
                carregarProjetoNaTela(projetoSalvo);
                
            } catch (e) { console.error(e); alert("Erro ao criar simulação."); } 
            finally { btn.disabled = false; btn.innerText = originalText; }
        }

        // --- GOOGLE AUTOCOMPLETE (MODAL) ---
        window.initAutocomplete = function() {
            const input = document.getElementById('new-endereco');
            if(!input) return;
            const autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: "br" }, fields: ["geometry", "formatted_address"], types: ["address"] });
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    document.getElementById('new-lat').value = place.geometry.location.lat();
                    document.getElementById('new-lng').value = place.geometry.location.lng();
                }
            });
        };

        // --- RENDER COMPLETO ---
        function renderizarDados(data) {
            try {
                if (!data.financeiro || !data.financeiro.fluxo_caixa_mensal) { alert("Erro de dados."); return; }
                const engenharia = data.engenharia?.projetado || {};
                const financeiro = data.financeiro || {};
                const config = data.configuracao_sistema || {};
                const detalhes = data.detalhes || {};

                document.getElementById('display-address').innerText = (detalhes.endereco_completo || "Local").split('-')[0];
                document.getElementById('display-specs').innerText = `${engenharia.potencia_instalada_kwp} kWp • ${engenharia.qtd_modulos}x ${config.modulo?.modelo}`;

                const bruto = financeiro.investimento_bruto || 0;
                const isDiscount = data.status?.desconto_aplicado || false;
                if(isDiscount) applyDiscountUI(bruto * 0.95); else removeDiscountUI(bruto);

                const geracaoAno1 = (engenharia.geracao_mensal_media_ano1 || 0) * 12;
                const economiaAno1 = financeiro.fluxo_caixa_mensal.slice(0, 12).reduce((a,b)=>a+b.economia_reais, 0);

                document.getElementById('kpi-generation').innerText = Math.round(geracaoAno1) + " kWh";
                document.getElementById('kpi-economy').innerText = economiaAno1.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0});
                document.getElementById('kpi-payback').innerText = (financeiro.payback_anos || 0) + " Anos";
                document.getElementById('kpi-roi').innerText = (financeiro.economia_total_acumulada || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0});

                if (data.status?.fase === "visita_agendada") {
                    document.getElementById('action-section').classList.add('hidden');
                    document.getElementById('status-locked-card').classList.remove('hidden');
                    document.getElementById('status-text').innerText = "Visita Agendada";
                    document.getElementById('status-text').className = "text-[10px] font-black uppercase tracking-[0.3em] text-blue-400";
                    document.getElementById('status-dot').className = "inline-block w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                } else {
                    document.getElementById('action-section').classList.remove('hidden');
                    document.getElementById('status-locked-card').classList.add('hidden');
                    document.getElementById('status-text').innerText = "Projeto Viável";
                    document.getElementById('status-text').className = "text-[10px] font-black uppercase tracking-[0.3em] text-green-500";
                    document.getElementById('status-dot').className = "inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse";
                    if (data.status?.fase === "em_analise_concorrencia") showAnaliseEnviadaUI(); else resetUploadUI();
                }

                document.getElementById('loading-skeleton').classList.add('hidden');
                document.getElementById('content-panel').classList.remove('hidden');
                updateChart();
            } catch (e) { console.error(e); }
        }

        // --- SISTEMA DE GRÁFICOS (AJUSTADO PARA LIMPEZA VISUAL) ---
        window.updateInterestRate = function(val) { currentInterestRate = parseFloat(val); document.getElementById('rate-display').innerText = currentInterestRate.toFixed(2) + "%"; updateChart(); }
        window.updateLoanTerm = function(val) { currentLoanTerm = parseInt(val); document.getElementById('term-display').innerText = currentLoanTerm + "x"; updateChart(); }
        
        window.switchChartMode = function(mode) {
            currentChartMode = mode;
            document.getElementById('mode-cash').className = mode === 'cash' ? 'toggle-btn active-green' : 'toggle-btn';
            document.getElementById('mode-finan').className = mode === 'finan' ? 'toggle-btn active' : 'toggle-btn';
            const btn1Year = document.getElementById('time-1');
            const finanControls = document.getElementById('finan-controls');
            if(mode === 'cash') {
                document.getElementById('chart-desc').innerText = "Comparativo de Acúmulo de Patrimônio vs CDI (Renda Fixa)";
                btn1Year.classList.add('hidden-important'); finanControls.classList.add('hidden'); 
                if(currentTimeRange === 1) window.switchTimeRange(25);
            } else {
                document.getElementById('chart-desc').innerText = "Simulador de Financiamento: Economia Mensal (Oscilação Sazonal)";
                btn1Year.classList.remove('hidden-important'); finanControls.classList.remove('hidden'); 
            }
            updateChart();
        }
        
        window.switchTimeRange = function(range) {
            currentTimeRange = range;
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`time-${range}`).classList.add('active');
            updateChart();
        }

        function updateChart() {
            if(!leadData || !leadData.financeiro.fluxo_caixa_mensal) return;
            const fluxo = leadData.financeiro.fluxo_caixa_mensal; 
            const precoString = document.getElementById('display-price').innerText;
            const investimento = parseFloat(precoString.replace(/[R$\s.]/g, '').replace(',', '.'));
            
            const ctx = document.getElementById('wealthChart').getContext('2d');
            const dados = fluxo.slice(0, currentTimeRange * 12);
            const labels = dados.map(d => d.mes_absoluto); 

            // GRADIENTE (Opcional, se quiser o visual premium)
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(34, 197, 94, 0.5)'); 
            gradient.addColorStop(1, 'rgba(34, 197, 94, 0.0)');

            if (currentChartMode === 'cash') {
                const labelsAnuais = []; const dataSolar = []; const dataCDI = [];
                labelsAnuais.push("Início"); dataSolar.push(-investimento); dataCDI.push(0);
                dados.forEach(d => {
                    if (d.mes_absoluto % 12 === 0) {
                        labelsAnuais.push("Ano " + d.ano);
                        const eco = fluxo.slice(0, d.mes_absoluto).reduce((acc, curr) => acc + curr.economia_reais, 0);
                        dataSolar.push(eco - investimento);
                        dataCDI.push((investimento * Math.pow(1.095, d.ano)) - investimento);
                    }
                });
                if (wealthChart) wealthChart.destroy();
                wealthChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labelsAnuais, 
                        datasets: [ 
                            { 
                                label: 'Patrimônio Solar', 
                                data: dataSolar, 
                                borderColor: '#22c55e', 
                                backgroundColor: gradient, // Gradiente restaurado
                                borderWidth: 3, 
                                pointRadius: 0, // MARCADORES ESCONDIDOS
                                pointHoverRadius: 6, // APARECEM NO HOVER
                                fill: true,
                                tension: 0.4 
                            }, 
                            { 
                                label: 'CDI', 
                                data: dataCDI, 
                                borderColor: '#64748b', 
                                borderDash: [5,5],
                                pointRadius: 0, // MARCADORES ESCONDIDOS
                                borderWidth: 2,
                                tension: 0.4 
                            } 
                        ] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false }, // Melhora o tooltip
                        plugins: { legend: { display: true, labels: {color:'#94a3b8'} } },
                        scales: { 
                            y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: { color:'#64748b' } }, 
                            x: { grid: {display:false}, ticks: { color:'#64748b' } } 
                        } 
                    } 
                });
            } else {
                const prazo = currentLoanTerm; const tx = currentInterestRate/100;
                const parc = (investimento * tx * Math.pow(1+tx, prazo)) / (Math.pow(1+tx, prazo) - 1);
                const dataEco = dados.map(d => d.economia_reais);
                const dataParc = dados.map((d, i) => (i >= 2 && i < prazo+2) ? parc : 0);
                
                if (wealthChart) wealthChart.destroy();
                wealthChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [ 
                            { 
                                label: 'Economia', 
                                data: dataEco, 
                                borderColor: '#22c55e',
                                borderWidth: 2,
                                pointRadius: 0, // MARCADORES ESCONDIDOS
                                tension: 0.4
                            }, 
                            { 
                                label: 'Parcela', 
                                data: dataParc, 
                                borderColor: '#3b82f6', 
                                borderWidth: 2,
                                pointRadius: 0, // MARCADORES ESCONDIDOS
                                fill: true,
                                tension: 0.1
                            } 
                        ] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        interaction: { mode: 'index', intersect: false },
                        scales: { x: { display: false }, y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: { color:'#64748b' } } } 
                    } 
                });
            }
        }

        window.toggleDiscount = async function() {
            if (!currentSimId || !currentUserEmail) return;
            const btn = document.getElementById('btn-discount');
            const isActive = btn.classList.contains('active');
            const bruto = parseFloat(leadData.financeiro.investimento_bruto);
            if (isNegotiating) window.toggleUpload();
            
            // ATENÇÃO: Atualiza na sub-coleção correta
            const docRef = db.collection("leads").doc(currentUserEmail).collection("simulacoes").doc(currentSimId);

            if (!isActive) {
                applyDiscountUI(bruto * 0.95);
                await docRef.update({ "status.desconto_aplicado": true });
            } else {
                removeDiscountUI(bruto);
                await docRef.update({ "status.desconto_aplicado": false });
            }
        }

        function applyDiscountUI(val) { document.getElementById('display-price').innerText = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); document.getElementById('display-price').classList.add('text-green-500'); document.getElementById('savings-badge').classList.remove('hidden'); document.getElementById('btn-discount').classList.add('active'); document.getElementById('btn-discount').innerHTML = '<i class="fas fa-check mr-2 text-green-500"></i> Desconto Ativado'; updateChart(); }
        function removeDiscountUI(val) { document.getElementById('display-price').innerText = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); document.getElementById('display-price').classList.remove('text-green-500'); document.getElementById('savings-badge').classList.add('hidden'); document.getElementById('btn-discount').classList.remove('active'); document.getElementById('btn-discount').innerHTML = '<i class="fas fa-tag mr-2 text-yellow-500"></i> Desconto à Vista'; updateChart(); }

        window.toggleUpload = function() {
            const uploadBox = document.getElementById('comp-upload');
            const btnFinal = document.getElementById('btn-final-action');
            const btnChallenge = document.getElementById('btn-challenge');
            if (document.getElementById('btn-discount').classList.contains('active')) window.toggleDiscount();
            uploadBox.classList.toggle('hidden');
            if (!uploadBox.classList.contains('hidden')) {
                isNegotiating = true;
                btnChallenge.classList.add('active'); 
                btnFinal.className = "btn-negotiate-action w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4";
                btnFinal.innerHTML = 'Solicitar Avaliação <i class="fas fa-file-signature text-sm"></i>';
                btnFinal.onclick = enviarAnaliseComparativa;
            } else {
                isNegotiating = false;
                btnChallenge.classList.remove('active');
                btnFinal.className = "btn-approve w-full sm:w-auto px-12 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-4";
                btnFinal.innerHTML = 'Aprovar e Agendar Visita <i class="fas fa-calendar-check text-sm"></i>';
                btnFinal.onclick = () => { if (currentSimId) window.location.href = `checkout.html?email=${encodeURIComponent(currentUserEmail)}&simId=${currentSimId}`; };
            }
        }

        function resetUploadUI() { document.getElementById('comp-upload').classList.add('hidden'); document.getElementById('btn-final-action').style.display = 'flex'; document.getElementById('btn-challenge').classList.remove('active'); }
        window.handleFileSelect = function(input) { if (input.files[0]) { selectedFile = input.files[0]; document.getElementById('upload-text').innerText = "Arquivo: " + selectedFile.name; } }
        async function enviarAnaliseComparativa() { if (!selectedFile) { alert("Selecione o PDF."); return; } const btn = document.getElementById('btn-final-action'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...'; try { const fileRef = storage.ref().child(`competitors/${currentSimId}/${selectedFile.name}`); await fileRef.put(selectedFile); const docRef = db.collection("leads").doc(currentUserEmail).collection("simulacoes").doc(currentSimId); await docRef.update({ "status.fase": "em_analise_concorrencia", "concorrencia": { nome_arquivo: selectedFile.name } }); showAnaliseEnviadaUI(); } catch (error) { alert("Erro ao enviar."); btn.disabled = false; } }
        function showAnaliseEnviadaUI() { document.getElementById('comp-upload').innerHTML = `<div class="text-center py-4"><h3 class="text-xl font-bold text-white">Solicitação Enviada!</h3></div>`; document.getElementById('comp-upload').classList.remove('hidden'); document.getElementById('btn-final-action').style.display = 'none'; }
        window.logout = () => auth.signOut().then(() => window.location.href = "index.html");
        document.getElementById('btn-final-action').onclick = () => { if (currentSimId) window.location.href = `checkout.html?email=${encodeURIComponent(currentUserEmail)}&simId=${currentSimId}`; };
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJ6SKOgB0TpR9d6XF1WmsRcHVQZG4tjrU&libraries=places&callback=initAutocomplete" async defer></script>
</body>
</html>
